<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ä»€ä¹ˆæ˜¯AQS?æºç åˆ†æ | ä¸å­¦ä¹ ä¼šè¢«æ€æ‰çš„ï¼</title><meta name="keywords" content="æºç "><meta name="author" content="ç« å¿—æˆ"><meta name="copyright" content="ç« å¿—æˆ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="AQSç®€ä»‹java.util.concurrent.locks.AbstractQueuedSynchronizer æŠ½è±¡ç±»ï¼Œç®€ç§° AQS ï¼Œæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé”å’ŒåŒæ­¥å®¹å™¨çš„åŒæ­¥å™¨ã€‚concurrent&#96; åŒ…å†…è®¸å¤šç±»éƒ½æ˜¯åŸºäº AQS æ„å»ºã€‚å¦‚ ReentrantLockï¼ŒSemaphoreï¼ŒCountDownLatchï¼ŒReentrantReadWriteLockï¼Œç­‰ã€‚ AQS ä½¿ç”¨ä¸€ä¸ª FIFO çš„">
<meta property="og:type" content="article">
<meta property="og:title" content="ä»€ä¹ˆæ˜¯AQS?æºç åˆ†æ">
<meta property="og:url" content="http://example.com/2021/03/06/%E4%BB%80%E4%B9%88%E6%98%AFAQS-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="ä¸å­¦ä¹ ä¼šè¢«æ€æ‰çš„ï¼">
<meta property="og:description" content="AQSç®€ä»‹java.util.concurrent.locks.AbstractQueuedSynchronizer æŠ½è±¡ç±»ï¼Œç®€ç§° AQS ï¼Œæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé”å’ŒåŒæ­¥å®¹å™¨çš„åŒæ­¥å™¨ã€‚concurrent&#96; åŒ…å†…è®¸å¤šç±»éƒ½æ˜¯åŸºäº AQS æ„å»ºã€‚å¦‚ ReentrantLockï¼ŒSemaphoreï¼ŒCountDownLatchï¼ŒReentrantReadWriteLockï¼Œç­‰ã€‚ AQS ä½¿ç”¨ä¸€ä¸ª FIFO çš„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-39em6d.png">
<meta property="article:published_time" content="2021-03-06T08:48:59.000Z">
<meta property="article:modified_time" content="2022-05-15T07:29:59.086Z">
<meta property="article:author" content="ç« å¿—æˆ">
<meta property="article:tag" content="æºç ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-39em6d.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/03/06/%E4%BB%80%E4%B9%88%E6%98%AFAQS-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-15 15:29:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/tx2.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">44</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> æ¸…å•</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> é“¾æ¥</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-messageboard"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-39em6d.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ä¸å­¦ä¹ ä¼šè¢«æ€æ‰çš„ï¼</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> æ¸…å•</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> é“¾æ¥</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-messageboard"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ä»€ä¹ˆæ˜¯AQS?æºç åˆ†æ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-03-06T08:48:59.000Z" title="å‘è¡¨äº 2021-03-06 16:48:59">2021-03-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-05-15T07:29:59.086Z" title="æ›´æ–°äº 2022-05-15 15:29:59">2022-05-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ä»€ä¹ˆæ˜¯AQS?æºç åˆ†æ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/2021/03/06/%E4%BB%80%E4%B9%88%E6%98%AFAQS-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2021/03/06/%E4%BB%80%E4%B9%88%E6%98%AFAQS-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p><code>java.util.concurrent.locks.AbstractQueuedSynchronizer</code> æŠ½è±¡ç±»ï¼Œç®€ç§° AQS ï¼Œæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºé”å’ŒåŒæ­¥å®¹å™¨çš„åŒæ­¥å™¨ã€‚concurrent` åŒ…å†…è®¸å¤šç±»éƒ½æ˜¯åŸºäº AQS æ„å»ºã€‚å¦‚ ReentrantLockï¼ŒSemaphoreï¼ŒCountDownLatchï¼ŒReentrantReadWriteLockï¼Œç­‰ã€‚</p>
<p>AQS ä½¿ç”¨ä¸€ä¸ª FIFO çš„é˜Ÿåˆ—è¡¨ç¤ºæ’é˜Ÿç­‰å¾…é”çš„çº¿ç¨‹ï¼Œé˜Ÿåˆ—å¤´èŠ‚ç‚¹ç§°ä½œâ€œå“¨å…µèŠ‚ç‚¹â€ï¼Œå®ƒä¸ä¸ä»»ä½•çº¿ç¨‹å…³è”ã€‚å…¶ä»–çš„èŠ‚ç‚¹ä¸ç­‰å¾…çº¿ç¨‹å…³è”ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªç­‰å¾…çŠ¶æ€ <code>waitStatus</code> ã€‚</p>
<p>å®ƒæ˜¯ J.U.C å¹¶å‘åŒ…ä¸­çš„æ ¸å¿ƒåŸºç¡€ç»„ä»¶ã€‚</p>
<h4 id="ä¼˜åŠ¿"><a href="#ä¼˜åŠ¿" class="headerlink" title="ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h4><p>AQS è§£å†³äº†åœ¨å®ç°åŒæ­¥å™¨æ—¶æ¶‰åŠå½“çš„å¤§é‡ç»†èŠ‚é—®é¢˜ï¼Œä¾‹å¦‚è·å–åŒæ­¥çŠ¶æ€ã€FIFO åŒæ­¥é˜Ÿåˆ—ã€‚åŸºäº AQS æ¥æ„å»ºåŒæ­¥å™¨å¯ä»¥å¸¦æ¥<strong>å¾ˆå¤šå¥½å¤„</strong>ã€‚å®ƒä¸ä»…èƒ½å¤Ÿæå¤§åœ°å‡å°‘å®ç°å·¥ä½œï¼Œè€Œä¸”ä¹Ÿä¸å¿…å¤„ç†åœ¨å¤šä¸ªä½ç½®ä¸Šå‘ç”Ÿçš„ç«äº‰é—®é¢˜ã€‚</p>
<p>åœ¨åŸºäº AQS æ„å»ºçš„åŒæ­¥å™¨ä¸­ï¼Œåªèƒ½åœ¨ä¸€ä¸ªæ—¶åˆ»å‘ç”Ÿé˜»å¡ï¼Œä»è€Œé™ä½ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæé«˜äº†ååé‡ã€‚åŒæ—¶åœ¨è®¾è®¡ AQS æ—¶å……åˆ†è€ƒè™‘äº†å¯ä¼¸ç¼©æ€§ï¼Œå› æ­¤ J.U.C ä¸­ï¼Œæ‰€æœ‰åŸºäº AQS æ„å»ºçš„åŒæ­¥å™¨å‡å¯ä»¥è·å¾—è¿™ä¸ªä¼˜åŠ¿ã€‚</p>
<h4 id="åŒæ­¥çŠ¶æ€"><a href="#åŒæ­¥çŠ¶æ€" class="headerlink" title="åŒæ­¥çŠ¶æ€"></a>åŒæ­¥çŠ¶æ€</h4><p>AQS çš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯<strong>ç»§æ‰¿</strong>ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿åŒæ­¥å™¨ï¼Œå¹¶å®ç°å®ƒçš„<strong>æŠ½è±¡æ–¹æ³•</strong>æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ã€‚</p>
<p>AQS ä½¿ç”¨ä¸€ä¸ª <code>int</code> ç±»å‹çš„æˆå‘˜å˜é‡ <code>state</code> æ¥<strong>è¡¨ç¤ºåŒæ­¥çŠ¶æ€</strong>ï¼š</p>
<ul>
<li>å½“ <code>state &gt; 0</code> æ—¶ï¼Œè¡¨ç¤ºå·²ç»è·å–äº†é”ã€‚</li>
<li>å½“ <code>state = 0</code> æ—¶ï¼Œè¡¨ç¤ºé‡Šæ”¾äº†é”ã€‚</li>
</ul>
<p>å®ƒæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œæ¥å¯¹åŒæ­¥çŠ¶æ€ <code>state</code> è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸” AQS å¯ä»¥ç¡®ä¿å¯¹ <code>state</code> çš„æ“ä½œæ˜¯<strong>å®‰å…¨</strong>çš„ï¼š</p>
<ul>
<li><code>#getState()</code></li>
<li><code>#setState(int newState)</code></li>
<li><code>#compareAndSetState(int expect, int update)</code></li>
</ul>
<h4 id="åŒæ­¥é˜Ÿåˆ—"><a href="#åŒæ­¥é˜Ÿåˆ—" class="headerlink" title="åŒæ­¥é˜Ÿåˆ—"></a>åŒæ­¥é˜Ÿåˆ—</h4><p>AQS é€šè¿‡å†…ç½®çš„ FIFO åŒæ­¥é˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„<strong>æ’é˜Ÿå·¥ä½œ</strong>ï¼š</p>
<ul>
<li>å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼ˆé”ï¼‰æ—¶ï¼ŒAQS åˆ™ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹</li>
<li>å½“åŒæ­¥çŠ¶æ€<strong>é‡Šæ”¾</strong>æ—¶ï¼Œåˆ™ä¼šæŠŠèŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚</li>
</ul>
<h4 id="ä¸»è¦å†…ç½®æ–¹æ³•"><a href="#ä¸»è¦å†…ç½®æ–¹æ³•" class="headerlink" title="ä¸»è¦å†…ç½®æ–¹æ³•"></a>ä¸»è¦å†…ç½®æ–¹æ³•</h4><p>AQS ä¸»è¦æä¾›äº†å¦‚ä¸‹<strong>æ–¹æ³•</strong>ï¼š</p>
<ul>
<li><code>#getState()</code>ï¼šè¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼ã€‚</li>
<li><code>#setState(int newState)</code>ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ã€‚</li>
<li><code>#compareAndSetState(int expect, int update)</code>ï¼šä½¿ç”¨ CAS è®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§ã€‚</li>
<li>ã€å¯é‡å†™ã€‘<code>#tryAcquire(int arg)</code>ï¼šç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–åŒæ­¥çŠ¶æ€æˆåŠŸåï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…è¯¥çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€æ‰èƒ½è·å–åŒæ­¥çŠ¶æ€ã€‚</li>
<li>ã€å¯é‡å†™ã€‘<code>#tryRelease(int arg)</code>ï¼šç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚</li>
<li>ã€å¯é‡å†™ã€‘<code>#tryAcquireShared(int arg)</code>ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›å€¼å¤§äºç­‰äº 0 ï¼Œåˆ™è¡¨ç¤ºè·å–æˆåŠŸï¼›å¦åˆ™ï¼Œè·å–å¤±è´¥ã€‚</li>
<li>ã€å¯é‡å†™ã€‘<code>#tryReleaseShared(int arg)</code>ï¼šå…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚</li>
<li>ã€å¯é‡å†™ã€‘<code>#isHeldExclusively()</code>ï¼šå½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å å¼æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ï¼Œä¸€èˆ¬è¯¥æ–¹æ³•è¡¨ç¤ºæ˜¯å¦è¢«å½“å‰çº¿ç¨‹æ‰€ç‹¬å ã€‚</li>
<li><code>acquire(int arg)</code>ï¼šç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç”±è¯¥æ–¹æ³•è¿”å›ï¼›å¦åˆ™ï¼Œå°†ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ã€‚è¯¥æ–¹æ³•å°†ä¼šè°ƒç”¨<strong>å¯é‡å†™</strong>çš„ <code>#tryAcquire(int arg)</code> æ–¹æ³•ï¼›</li>
<li><code>#acquireInterruptibly(int arg)</code>ï¼šä¸ <code>#acquire(int arg)</code> ç›¸åŒï¼Œä½†æ˜¯è¯¥æ–¹æ³•å“åº”ä¸­æ–­ã€‚å½“å‰çº¿ç¨‹ä¸ºè·å–åˆ°åŒæ­¥çŠ¶æ€è€Œè¿›å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡ºInterruptedException å¼‚å¸¸å¹¶è¿”å›ã€‚</li>
<li><code>#tryAcquireNanos(int arg, long nanos)</code>ï¼šè¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨ nanos æ—¶é—´å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œé‚£ä¹ˆå°†ä¼šè¿”å› false ï¼Œå·²ç»è·å–åˆ™è¿”å› true ã€‚</li>
<li><code>#acquireShared(int arg)</code>ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œå°†ä¼šè¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œä¸ç‹¬å å¼çš„ä¸»è¦åŒºåˆ«æ˜¯åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼›</li>
<li><code>#acquireSharedInterruptibly(int arg)</code>ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå“åº”ä¸­æ–­ã€‚</li>
<li><code>#tryAcquireSharedNanos(int arg, long nanosTimeout)</code>ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¢åŠ è¶…æ—¶é™åˆ¶ã€‚</li>
<li><code>#release(int arg)</code>ï¼šç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«çš„çº¿ç¨‹å”¤é†’ã€‚</li>
<li><code>#releaseShared(int arg)</code>ï¼šå…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚</li>
</ul>
<p>ä»ä¸Šé¢çš„æ–¹æ³•çœ‹ä¸‹æ¥ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ†æˆ <strong>3</strong> ç±»ï¼š</p>
<ul>
<li><strong>ç‹¬å å¼</strong>â€”â€“éå…¬å¹³é”â€”-è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€</li>
<li><strong>å…±äº«å¼</strong>â€”â€“å…¬å¹³é”â€”-è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€</li>
<li>æŸ¥è¯¢<strong>åŒæ­¥é˜Ÿåˆ—</strong>ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µ</li>
</ul>
<hr>
<h3 id="AQSï¼šCLH-åŒæ­¥é˜Ÿåˆ—"><a href="#AQSï¼šCLH-åŒæ­¥é˜Ÿåˆ—" class="headerlink" title="AQSï¼šCLH åŒæ­¥é˜Ÿåˆ—"></a>AQSï¼šCLH åŒæ­¥é˜Ÿåˆ—</h3><h4 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>CLH åŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ª FIFO <strong>åŒå‘</strong>é˜Ÿåˆ—ï¼ŒAQS ä¾èµ–å®ƒæ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼š</p>
<ul>
<li>å½“å‰çº¿ç¨‹å¦‚æœè·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒAQSåˆ™ä¼šå°†å½“å‰çº¿ç¨‹å·²ç»ç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹</li>
<li>å½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹å”¤é†’ï¼ˆå…¬å¹³é”ï¼‰ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚</li>
</ul>
<h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h4><p>åœ¨ CLH åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œ<strong>ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œè¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹</strong>ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆ<code>thread</code>ï¼‰ã€çŠ¶æ€ï¼ˆ<code>waitStatus</code>ï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆ<code>prev</code>ï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆ<code>next</code>ï¼‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Node æ˜¯ AbstractQueuedSynchronizer çš„å†…éƒ¨é™æ€ç±»ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">static final class Node &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å…±äº«</span><br><span class="line">    static final Node SHARED &#x3D; new Node();</span><br><span class="line">    &#x2F;&#x2F; ç‹¬å </span><br><span class="line">    static final Node EXCLUSIVE &#x3D; null;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * å› ä¸ºè¶…æ—¶æˆ–è€…ä¸­æ–­ï¼ŒèŠ‚ç‚¹ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œè¢«å–æ¶ˆçš„èŠ‚ç‚¹æ—¶ä¸ä¼šå‚ä¸åˆ°ç«äº‰ä¸­çš„ï¼Œä»–ä¼šä¸€ç›´ä¿æŒå–æ¶ˆçŠ¶æ€ä¸ä¼šè½¬å˜ä¸ºå…¶ä»–çŠ¶æ€</span><br><span class="line">     *&#x2F;</span><br><span class="line">    static final int CANCELLED &#x3D;  1;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œå½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹å¦‚æœé‡Šæ”¾äº†åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆï¼Œå°†ä¼šé€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œä½¿åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¾—ä»¥è¿è¡Œ</span><br><span class="line">     *&#x2F;</span><br><span class="line">    static final int SIGNAL    &#x3D; -1;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨äº†signal()åï¼Œè¯¥èŠ‚ç‚¹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°åŒæ­¥çŠ¶æ€çš„è·å–ä¸­</span><br><span class="line">     *&#x2F;</span><br><span class="line">    static final int CONDITION &#x3D; -2;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ï¼Œå°†ä¼šæ— æ¡ä»¶åœ°ä¼ æ’­ä¸‹å»</span><br><span class="line">     *&#x2F;</span><br><span class="line">    static final int PROPAGATE &#x3D; -3;</span><br><span class="line"></span><br><span class="line">    &#x2F;** ç­‰å¾…çŠ¶æ€ *&#x2F;</span><br><span class="line">    volatile int waitStatus;</span><br><span class="line"></span><br><span class="line">    &#x2F;** å‰é©±èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—æ—¶è¢«è®¾ç½®ï¼ˆå°¾éƒ¨æ·»åŠ ï¼‰ *&#x2F;</span><br><span class="line">    volatile Node prev;</span><br><span class="line"></span><br><span class="line">    &#x2F;** åç»§èŠ‚ç‚¹ *&#x2F;</span><br><span class="line">    volatile Node next;</span><br><span class="line"></span><br><span class="line">    &#x2F;** ç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»­èŠ‚ç‚¹ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å…±äº«çš„ï¼Œé‚£ä¹ˆå­—æ®µå°†æ˜¯ä¸€ä¸ª SHARED å¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´èŠ‚ç‚¹ç±»å‹ï¼ˆç‹¬å å’Œå…±äº«ï¼‰å’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»­èŠ‚ç‚¹å…±ç”¨åŒä¸€ä¸ªå­—æ®µ *&#x2F;</span><br><span class="line">    Node nextWaiter;</span><br><span class="line">    </span><br><span class="line">    &#x2F;** è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ *&#x2F;</span><br><span class="line">    volatile Thread thread;</span><br><span class="line"></span><br><span class="line">    final boolean isShared() &#123;</span><br><span class="line">        return nextWaiter &#x3D;&#x3D; SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final Node predecessor() throws NullPointerException &#123;</span><br><span class="line">        Node p &#x3D; prev;</span><br><span class="line">        if (p &#x3D;&#x3D; null)</span><br><span class="line">            throw new NullPointerException();</span><br><span class="line">        else</span><br><span class="line">            return p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123; &#x2F;&#x2F; Used to establish initial head or SHARED marker</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123; &#x2F;&#x2F; Used by addWaiter</span><br><span class="line">        this.nextWaiter &#x3D; mode;</span><br><span class="line">        this.thread &#x3D; thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, int waitStatus) &#123; &#x2F;&#x2F; Used by Condition</span><br><span class="line">        this.waitStatus &#x3D; waitStatus;</span><br><span class="line">        this.thread &#x3D; thread;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>waitStatus</code> å­—æ®µï¼Œç­‰å¾…çŠ¶æ€ï¼Œç”¨æ¥æ§åˆ¶çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’ï¼Œå¹¶ä¸”å¯ä»¥é¿å…ä¸å¿…è¦çš„è°ƒç”¨LockSupportçš„ <code>#park(...)</code> å’Œ <code>#unpark(...)</code> æ–¹æ³•ã€‚</p>
<p>CLH åŒæ­¥é˜Ÿåˆ—ï¼Œç»“æ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120810001.png" alt="CLH åŒæ­¥é˜Ÿåˆ—"></p>
<ul>
<li><code>prev</code> å’Œ <code>next</code> å­—æ®µï¼Œæ˜¯ <strong>AbstractQueuedSynchronizer</strong> çš„å­—æ®µï¼Œåˆ†åˆ«æŒ‡å‘åŒæ­¥é˜Ÿåˆ—çš„å¤´å’Œå°¾ã€‚</li>
<li><code>head</code> å’Œ <code>tail</code> å­—æ®µï¼Œåˆ†åˆ«æŒ‡å‘ Node èŠ‚ç‚¹çš„<strong>å‰ä¸€ä¸ª</strong>å’Œ<strong>åä¸€ä¸ª</strong> Node èŠ‚ç‚¹ï¼Œä»è€Œå®ç°<strong>é“¾å¼åŒå‘é˜Ÿåˆ—</strong>ã€‚å†é…åˆä¸Š <code>prev</code> å’Œ <code>next</code> å­—æ®µï¼Œå¿«é€Ÿå®šä½åˆ°åŒæ­¥é˜Ÿåˆ—çš„å¤´å°¾ã€‚</li>
</ul>
<h4 id="å…¥åˆ—"><a href="#å…¥åˆ—" class="headerlink" title="å…¥åˆ—"></a>å…¥åˆ—</h4><ul>
<li><code>tail</code> æŒ‡å‘æ–°èŠ‚ç‚¹ã€‚</li>
<li>æ–°èŠ‚ç‚¹çš„ <code>prev</code> æŒ‡å‘å½“å‰æœ€åçš„èŠ‚ç‚¹ã€‚</li>
<li>å½“å‰æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„ <code>next</code> æŒ‡å‘å½“å‰èŠ‚ç‚¹ã€‚</li>
</ul>
<p>è¿‡ç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120810002.png" alt="å…¥åˆ— æµç¨‹"></p>
<p>ä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œå…¥é˜Ÿé€»è¾‘å®ç°çš„ <code>#addWaiter(Node)</code> æ–¹æ³•ï¼Œéœ€è¦è€ƒè™‘<strong>å¹¶å‘</strong>çš„æƒ…å†µã€‚å®ƒé€šè¿‡ <strong>CAS</strong> çš„æ–¹å¼ï¼Œæ¥ä¿è¯æ­£ç¡®çš„æ·»åŠ  Node ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> 1: private Node addWaiter(Node mode) &#123;</span><br><span class="line"> 2:     &#x2F;&#x2F; æ–°å»ºèŠ‚ç‚¹</span><br><span class="line"> 3:     Node node &#x3D; new Node(Thread.currentThread(), mode);</span><br><span class="line"> 4:     &#x2F;&#x2F; è®°å½•åŸå°¾èŠ‚ç‚¹</span><br><span class="line"> 5:     Node pred &#x3D; tail;</span><br><span class="line"> 6:     &#x2F;&#x2F; å¿«é€Ÿå°è¯•ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹</span><br><span class="line"> 7:     if (pred !&#x3D; null) &#123;</span><br><span class="line"> 8:         &#x2F;&#x2F; è®¾ç½®æ–° Node èŠ‚ç‚¹çš„å°¾èŠ‚ç‚¹ä¸ºåŸå°¾èŠ‚ç‚¹</span><br><span class="line"> 9:         node.prev &#x3D; pred;</span><br><span class="line">10:         &#x2F;&#x2F; CAS è®¾ç½®æ–°çš„å°¾èŠ‚ç‚¹</span><br><span class="line">11:         if (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">12:             &#x2F;&#x2F; æˆåŠŸï¼ŒåŸå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</span><br><span class="line">13:             pred.next &#x3D; node;</span><br><span class="line">14:             return node;</span><br><span class="line">15:         &#125;</span><br><span class="line">16:     &#125;</span><br><span class="line">17:     &#x2F;&#x2F; å¤±è´¥ï¼Œå¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸ</span><br><span class="line">18:     enq(node);</span><br><span class="line">19:     return node;</span><br><span class="line">20: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¬¬ 3 è¡Œï¼šåˆ›å»ºæ–°èŠ‚ç‚¹ <code>node</code> ã€‚åœ¨åˆ›å»ºçš„æ„é€ æ–¹æ³•ï¼Œ<code>mode</code> æ–¹æ³•å‚æ•°ï¼Œä¼ é€’è·å–åŒæ­¥çŠ¶æ€çš„æ¨¡å¼ã€‚</p>
</li>
<li><p>ç¬¬ 5 è¡Œï¼šè®°å½•<strong>åŸ</strong>å°¾èŠ‚ç‚¹ <code>tail</code> ã€‚</p>
</li>
<li><p>åœ¨ä¸‹é¢çš„ä»£ç ï¼Œä¼šåˆ†æˆ2éƒ¨åˆ†ï¼š</p>
<ul>
<li>ç¬¬ 6 è‡³ 16 è¡Œï¼š<strong>å¿«é€Ÿ</strong>å°è¯•ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šæ·»åŠ å¤±è´¥ï¼Œ<strong>å¤šæ¬¡</strong>å°è¯•ï¼Œç›´åˆ°æˆåŠŸæ·»åŠ ã€‚</li>
</ul>
</li>
<li><p>========== ç¬¬ <strong>1</strong> éƒ¨åˆ† ==========</p>
</li>
<li><p>ç¬¬ 7 è¡Œï¼šå½“<strong>åŸ</strong>å°¾èŠ‚ç‚¹éç©ºï¼Œæ‰æ‰§è¡Œ<strong>å¿«é€Ÿ</strong>å°è¯•çš„é€»è¾‘ã€‚åœ¨ä¸‹é¢çš„ <code>#enq(Node node)</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œ<strong>é¦–</strong>èŠ‚ç‚¹æœªåˆå§‹åŒ–çš„æ—¶ï¼Œ<code>head</code> å’Œ <code>tail</code> éƒ½ä¸ºç©ºã€‚</p>
</li>
<li><p>ç¬¬ 9 è¡Œï¼šè®¾ç½®<strong>æ–°</strong>èŠ‚ç‚¹çš„<strong>å°¾</strong>èŠ‚ç‚¹ä¸º<strong>åŸ</strong>å°¾èŠ‚ç‚¹ã€‚</p>
</li>
<li><p>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>#compareAndSetTail(Node expect, Node update)</code> æ–¹æ³•ï¼Œä½¿ç”¨ <strong>Unsafe</strong> æ¥ <strong>CAS</strong> è®¾ç½®<strong>å°¾</strong>èŠ‚ç‚¹ <code>tail</code> ä¸º<strong>æ–°</strong>èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static final Unsafe unsafe &#x3D; Unsafe.getUnsafe();</span><br><span class="line"></span><br><span class="line">private static final long tailOffset &#x3D; unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField(&quot;tail&quot;));  &#x2F;&#x2F; è¿™å—ä»£ç ï¼Œå®é™…åœ¨ static ä»£ç å—ï¼Œæ­¤å¤„ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåšäº†ç®€åŒ–ã€‚</span><br><span class="line"></span><br><span class="line">private final boolean compareAndSetTail(Node expect, Node update) &#123;</span><br><span class="line">    return unsafe.compareAndSwapObject(this, tailOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ç¬¬ 13 è¡Œï¼šæ·»åŠ <strong>æˆåŠŸ</strong>ï¼Œæœ€ç»ˆï¼Œå°†<strong>åŸ</strong>å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º<strong>æ–°</strong>èŠ‚ç‚¹ã€‚</p>
</li>
<li><p>ç¬¬ 14 è¡Œï¼šè¿”å›<strong>æ–°</strong>èŠ‚ç‚¹ã€‚</p>
</li>
<li><p>å¦‚æœæ·»åŠ <strong>å¤±è´¥</strong>ï¼Œå› ä¸ºå­˜åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼Œæ­¤æ—¶éœ€è¦æ‰§è¡Œã€ç¬¬ 18 è¡Œã€‘çš„ä»£ç ã€‚</p>
</li>
<li><p>========== ç¬¬ <strong>2</strong> éƒ¨åˆ† ==========</p>
</li>
<li><p>è°ƒç”¨ <code>#enq(Node node)</code> æ–¹æ³•ï¼Œ<strong>å¤šæ¬¡</strong>å°è¯•ï¼Œç›´åˆ°æˆåŠŸæ·»åŠ ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> 1: private Node enq(final Node node) &#123;</span><br><span class="line"> 2:     &#x2F;&#x2F; å¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</span><br><span class="line"> 3:     for (;;) &#123;</span><br><span class="line"> 4:         &#x2F;&#x2F; è®°å½•åŸå°¾èŠ‚ç‚¹</span><br><span class="line"> 5:         Node t &#x3D; tail;</span><br><span class="line"> 6:         &#x2F;&#x2F; åŸå°¾èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºé¦–å°¾èŠ‚ç‚¹éƒ½ä¸º new Node()</span><br><span class="line"> 7:         if (t &#x3D;&#x3D; null) &#123;</span><br><span class="line"> 8:             if (compareAndSetHead(new Node()))</span><br><span class="line"> 9:                 tail &#x3D; head;</span><br><span class="line">10:         &#x2F;&#x2F; åŸå°¾èŠ‚ç‚¹å­˜åœ¨ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹</span><br><span class="line">11:         &#125; else &#123;</span><br><span class="line">12:             &#x2F;&#x2F;è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹</span><br><span class="line">13:             node.prev &#x3D; t;</span><br><span class="line">14:             &#x2F;&#x2F; CAS è®¾ç½®æ–°çš„å°¾èŠ‚ç‚¹</span><br><span class="line">15:             if (compareAndSetTail(t, node)) &#123;</span><br><span class="line">16:                 &#x2F;&#x2F; æˆåŠŸï¼ŒåŸå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</span><br><span class="line">17:                 t.next &#x3D; node;</span><br><span class="line">18:                 return t;</span><br><span class="line">19:             &#125;</span><br><span class="line">20:         &#125;</span><br><span class="line">21:     &#125;</span><br><span class="line">22: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 3 è¡Œï¼šâ€œ<strong>æ­»</strong>â€å¾ªç¯ï¼Œå¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸæ·»åŠ <strong>ä¸ºæ­¢</strong>ã€ç¬¬ 18 è¡Œã€‘ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè®°å½•åŸå°¾èŠ‚ç‚¹ <code>t</code> ã€‚ğŸ™‚ å’Œ <code>#addWaiter(Node node)</code> æ–¹æ³•çš„ã€ç¬¬ 5 è¡Œã€‘ç›¸åŒã€‚</li>
<li>ç¬¬ 10 è‡³ 19 è¡Œï¼šåŸå°¾èŠ‚ç‚¹å­˜åœ¨ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹ã€‚ğŸ™‚ å’Œ <code>#addWaiter(Node node)</code> æ–¹æ³•çš„ã€ç¬¬ 7 è‡³ 16 è¡Œã€‘ç›¸åŒã€‚</li>
<li>ç¬¬ 6 è‡³ 9 è¡Œï¼šåŸå°¾èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»º<strong>é¦–å°¾</strong>èŠ‚ç‚¹éƒ½ä¸º <strong>new Node()</strong> ã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤æ—¶ä¿®æ”¹çš„<strong>é¦–å°¾</strong>èŠ‚ç‚¹æ˜¯é‡æ–°åˆ›å»º( <code>new Node()</code> )çš„ï¼Œè€Œä¸æ˜¯<strong>æ–°èŠ‚ç‚¹</strong>ï¼</li>
</ul>
</li>
</ul>
<h4 id="å‡ºåˆ—"><a href="#å‡ºåˆ—" class="headerlink" title="å‡ºåˆ—"></a>å‡ºåˆ—</h4><p>CLH åŒæ­¥é˜Ÿåˆ—éµå¾ª FIFOï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†ä¼šå”¤é†’å®ƒçš„<strong>ä¸‹ä¸€ä¸ª</strong>èŠ‚ç‚¹ï¼ˆ<code>Node.next</code>ï¼‰ã€‚è€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶ï¼Œå°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹( <code>head</code> )ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹éå¸¸ç®€å•ï¼Œ<code>head</code> æ‰§è¡Œè¯¥èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„ <code>next</code> å’Œå½“å‰èŠ‚ç‚¹çš„ <code>prev</code> å³å¯ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹æ˜¯<strong>ä¸éœ€è¦ä½¿ç”¨ CAS æ¥ä¿è¯</strong>çš„ï¼Œå› ä¸º<strong>åªæœ‰ä¸€ä¸ª</strong>çº¿ç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚</p>
<p>è¿‡ç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120810003.png" alt="è¿‡ç¨‹å›¾"></p>
<p><code>#setHead(Node node)</code> æ–¹æ³•ï¼Œå®ç°ä¸Šè¿°çš„<strong>å‡ºåˆ—</strong>é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private void setHead(Node node) &#123;</span><br><span class="line">    head &#x3D; node;</span><br><span class="line">    node.thread &#x3D; null;</span><br><span class="line">    node.prev &#x3D; null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾"><a href="#AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾"></a>AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾</h3><p>AQS çš„è®¾è®¡æ¨¡å¼é‡‡ç”¨çš„<strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿çš„æ–¹å¼ï¼Œå®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ã€‚å¯¹äºå­ç±»è€Œè¨€ï¼Œå®ƒå¹¶æ²¡æœ‰å¤ªå¤šçš„æ´»è¦åšï¼ŒAQS å·²ç»æä¾›äº†å¤§é‡çš„æ¨¡æ¿æ–¹æ³•æ¥å®ç°åŒæ­¥ï¼Œä¸»è¦æ˜¯åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>ç‹¬å å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€</li>
<li>å…±äº«å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€</li>
<li>æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µã€‚</li>
</ul>
<p>è‡ªå®šä¹‰å­ç±»ä½¿ç”¨ AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œå°±å¯ä»¥å®ç°<strong>è‡ªå·±çš„åŒæ­¥è¯­ä¹‰</strong>ã€‚</p>
<h4 id="ç‹¬å å¼"><a href="#ç‹¬å å¼" class="headerlink" title="ç‹¬å å¼"></a>ç‹¬å å¼</h4><p>ç‹¬å å¼ï¼Œ<strong>åŒä¸€æ—¶åˆ»ï¼Œä»…æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰åŒæ­¥çŠ¶æ€</strong>ã€‚</p>
<h5 id="ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–"><a href="#ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–" class="headerlink" title="ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–"></a>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–</h5><p><code>#acquire(int arg)</code> æ–¹æ³•ï¼Œä¸º AQS æä¾›çš„<strong>æ¨¡æ¿æ–¹æ³•</strong>ã€‚è¯¥æ–¹æ³•ä¸ºç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯è¯¥æ–¹æ³•å¯¹<strong>ä¸­æ–­ä¸æ•æ„Ÿ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”±äºçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥è€ŒåŠ å…¥åˆ° CLH åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåç»­å¯¹è¯¥çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œæ—¶ï¼Œçº¿ç¨‹<strong>ä¸ä¼š</strong>ä» CLH åŒæ­¥é˜Ÿåˆ—ä¸­<strong>ç§»é™¤</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1: public final void acquire(int arg) &#123;</span><br><span class="line">2:     if (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">3:         acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">4:         selfInterrupt();</span><br><span class="line">5: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¬¬ 2 è¡Œï¼šè°ƒç”¨ <code>#tryAcquire(int arg)</code> æ–¹æ³•ï¼Œå»å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–æˆåŠŸåˆ™è®¾ç½®é”çŠ¶æ€å¹¶è¿”å› true ï¼Œå¦åˆ™è·å–å¤±è´¥ï¼Œè¿”å› false ã€‚è‹¥è·å–æˆåŠŸï¼Œ<code>#acquire(int arg)</code> æ–¹æ³•ï¼Œç›´æ¥è¿”å›ï¼Œ<strong>ä¸ç”¨çº¿ç¨‹é˜»å¡</strong>ï¼Œè‡ªæ—‹ç›´åˆ°è·å¾—åŒæ­¥çŠ¶æ€æˆåŠŸã€‚</p>
</li>
<li><p>ç¬¬ 3 è¡Œï¼šå¦‚æœ <code>#tryAcquire(int arg)</code> æ–¹æ³•è¿”å› false ï¼Œå³è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼Œåˆ™è°ƒç”¨ <code>#addWaiter(Node mode)</code> æ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ° CLH åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ã€‚å¹¶ä¸”ï¼Œ <code>mode</code> æ–¹æ³•å‚æ•°ä¸º <code>Node.EXCLUSIVE</code> ï¼Œè¡¨ç¤º<strong>ç‹¬å </strong>æ¨¡å¼ã€‚</p>
</li>
<li><p>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>boolean #acquireQueued(Node node, int arg)</code> æ–¹æ³•ï¼Œè‡ªæ—‹ç›´åˆ°è·å¾—åŒæ­¥çŠ¶æ€æˆåŠŸã€‚å¦å¤–ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸º <code>boolean</code> ï¼Œå½“è¿”å› true æ—¶ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿè¿‡<strong>çº¿ç¨‹ä¸­æ–­</strong>ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•åˆä¼š<strong>æ¸…ç†</strong>çº¿ç¨‹ä¸­æ–­çš„<strong>æ ‡è¯†</strong>ï¼Œæ‰€ä»¥åœ¨ç§æƒ…å†µä¸‹ï¼Œéœ€è¦è°ƒç”¨ã€ç¬¬ 4 è¡Œã€‘çš„ <code>#selfInterrupt()</code> æ–¹æ³•ï¼Œæ¢å¤çº¿ç¨‹ä¸­æ–­çš„<strong>æ ‡è¯†</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static void selfInterrupt() &#123;</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="acquireQueued"><a href="#acquireQueued" class="headerlink" title="acquireQueued"></a>acquireQueued</h6><p><code>boolean #acquireQueued(Node node, int arg)</code> æ–¹æ³•ï¼Œä¸ºä¸€ä¸ª<strong>è‡ªæ—‹</strong>çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰çº¿ç¨‹ï¼ˆNodeï¼‰è¿›å…¥åŒæ­¥é˜Ÿåˆ—åï¼Œå°±ä¼šè¿›å…¥ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼š<strong>è‡ªçœ</strong>åœ°è§‚å¯Ÿï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°åŒæ­¥çŠ¶æ€åï¼Œå°±å¯ä»¥ä»è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºï¼Œå¦åˆ™ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ã€‚</p>
<p><strong>æµç¨‹å›¾</strong>å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120811001.png" alt="æµç¨‹å›¾"></p>
<p><strong>ä»£ç </strong>å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> 1: final boolean acquireQueued(final Node node, int arg) &#123;</span><br><span class="line"> 2:     &#x2F;&#x2F; è®°å½•æ˜¯å¦è·å–åŒæ­¥çŠ¶æ€æˆåŠŸ</span><br><span class="line"> 3:     boolean failed &#x3D; true;</span><br><span class="line"> 4:     try &#123;</span><br><span class="line"> 5:         &#x2F;&#x2F; è®°å½•è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å‘ç”Ÿçº¿ç¨‹ä¸­æ–­</span><br><span class="line"> 6:         boolean interrupted &#x3D; false;</span><br><span class="line"> 7:         &#x2F;*</span><br><span class="line"> 8:          * è‡ªæ—‹è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯è€Œå·²</span><br><span class="line"> 9:          *&#x2F;</span><br><span class="line">10:         for (;;) &#123;</span><br><span class="line">11:             &#x2F;&#x2F; å½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹</span><br><span class="line">12:             final Node p &#x3D; node.predecessor();</span><br><span class="line">13:             &#x2F;&#x2F; å½“å‰çº¿ç¨‹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ï¼Œä¸”åŒæ­¥çŠ¶æ€æˆåŠŸ</span><br><span class="line">14:             if (p &#x3D;&#x3D; head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">15:                 setHead(node);</span><br><span class="line">16:                 p.next &#x3D; null; &#x2F;&#x2F; help GC</span><br><span class="line">17:                 failed &#x3D; false;</span><br><span class="line">18:                 return interrupted;</span><br><span class="line">19:             &#125;</span><br><span class="line">20:             &#x2F;&#x2F; è·å–å¤±è´¥ï¼Œçº¿ç¨‹ç­‰å¾…--å…·ä½“åé¢ä»‹ç»</span><br><span class="line">21:             if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">22:                     parkAndCheckInterrupt())</span><br><span class="line">23:                 interrupted &#x3D; true;</span><br><span class="line">24:         &#125;</span><br><span class="line">25:     &#125; finally &#123;</span><br><span class="line">26:         &#x2F;&#x2F; è·å–åŒæ­¥çŠ¶æ€å‘ç”Ÿå¼‚å¸¸ï¼Œå–æ¶ˆè·å–ã€‚</span><br><span class="line">27:         if (failed)</span><br><span class="line">28:             cancelAcquire(node);</span><br><span class="line">29:     &#125;</span><br><span class="line">30: &#125;</span><br></pre></td></tr></table></figure>

<h6 id="shouldParkAfterFailedAcquire"><a href="#shouldParkAfterFailedAcquire" class="headerlink" title="shouldParkAfterFailedAcquire"></a>shouldParkAfterFailedAcquire</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 1: private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123;</span><br><span class="line"> 2:     &#x2F;&#x2F; è·å¾—å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span><br><span class="line"> 3:     int ws &#x3D; pred.waitStatus;</span><br><span class="line"> 4:     if (ws &#x3D;&#x3D; Node.SIGNAL) &#x2F;&#x2F;  Node.SIGNAL</span><br><span class="line"> 5:         &#x2F;*</span><br><span class="line"> 6:          * This node has already set status asking a release</span><br><span class="line"> 7:          * to signal it, so it can safely park.</span><br><span class="line"> 8:          *&#x2F;</span><br><span class="line"> 9:         return true;</span><br><span class="line">10:     if (ws &gt; 0) &#123; &#x2F;&#x2F; Node.CANCEL</span><br><span class="line">11:         &#x2F;*</span><br><span class="line">12:          * Predecessor was cancelled. Skip over predecessors and</span><br><span class="line">13:          * indicate retry.</span><br><span class="line">14:          *&#x2F;</span><br><span class="line">15:         do &#123;</span><br><span class="line">16:             node.prev &#x3D; pred &#x3D; pred.prev;</span><br><span class="line">17:         &#125; while (pred.waitStatus &gt; 0);</span><br><span class="line">18:         pred.next &#x3D; node;</span><br><span class="line">19:     &#125; else &#123; &#x2F;&#x2F; 0 æˆ–è€… Node.PROPAGATE</span><br><span class="line">20:         &#x2F;*</span><br><span class="line">21:          * waitStatus must be 0 or PROPAGATE.  Indicate that we</span><br><span class="line">22:          * need a signal, but don&#39;t park yet.  Caller will need to</span><br><span class="line">23:          * retry to make sure it cannot acquire before parking.</span><br><span class="line">24:          *&#x2F;</span><br><span class="line">25:         compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">26:     &#125;</span><br><span class="line">27:     return false;</span><br><span class="line">28: &#125;</span><br></pre></td></tr></table></figure>

<h6 id="cancelAcquire"><a href="#cancelAcquire" class="headerlink" title="cancelAcquire"></a>cancelAcquire</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> 1: private void cancelAcquire(Node node) &#123;</span><br><span class="line"> 2:     &#x2F;&#x2F; Ignore if node doesn&#39;t exist</span><br><span class="line"> 3:     if (node &#x3D;&#x3D; null)</span><br><span class="line"> 4:         return;</span><br><span class="line"> 5: </span><br><span class="line"> 6:     node.thread &#x3D; null;</span><br><span class="line"> 7: </span><br><span class="line"> 8:     &#x2F;&#x2F; Skip cancelled predecessors</span><br><span class="line"> 9:     Node pred &#x3D; node.prev;</span><br><span class="line">10:     while (pred.waitStatus &gt; 0)</span><br><span class="line">11:         node.prev &#x3D; pred &#x3D; pred.prev;</span><br><span class="line">12: </span><br><span class="line">13:     &#x2F;&#x2F; predNext is the apparent node to unsplice. CASes below will</span><br><span class="line">14:     &#x2F;&#x2F; fail if not, in which case, we lost race vs another cancel</span><br><span class="line">15:     &#x2F;&#x2F; or signal, so no further action is necessary.</span><br><span class="line">16:     Node predNext &#x3D; pred.next;</span><br><span class="line">17: </span><br><span class="line">18:     &#x2F;&#x2F; Can use unconditional write instead of CAS here.</span><br><span class="line">19:     &#x2F;&#x2F; After this atomic step, other Nodes can skip past us.</span><br><span class="line">20:     &#x2F;&#x2F; Before, we are free of interference from other threads.</span><br><span class="line">21:     node.waitStatus &#x3D; Node.CANCELLED;</span><br><span class="line">22: </span><br><span class="line">23:     &#x2F;&#x2F; If we are the tail, remove ourselves.</span><br><span class="line">24:     if (node &#x3D;&#x3D; tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">25:         compareAndSetNext(pred, predNext, null);</span><br><span class="line">26:     &#125; else &#123;</span><br><span class="line">27:         &#x2F;&#x2F; If successor needs signal, try to set pred&#39;s next-link</span><br><span class="line">28:         &#x2F;&#x2F; so it will get one. Otherwise wake it up to propagate.</span><br><span class="line">29:         int ws;</span><br><span class="line">30:         if (pred !&#x3D; head &amp;&amp;</span><br><span class="line">31:             ((ws &#x3D; pred.waitStatus) &#x3D;&#x3D; Node.SIGNAL ||</span><br><span class="line">32:              (ws &lt;&#x3D; 0 &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">33:             pred.thread !&#x3D; null) &#123;</span><br><span class="line">34:             Node next &#x3D; node.next;</span><br><span class="line">35:             if (next !&#x3D; null &amp;&amp; next.waitStatus &lt;&#x3D; 0)</span><br><span class="line">36:                 compareAndSetNext(pred, predNext, next);</span><br><span class="line">37:         &#125; else &#123;</span><br><span class="line">38:             unparkSuccessor(node);</span><br><span class="line">39:         &#125;</span><br><span class="line">40: </span><br><span class="line">41:         node.next &#x3D; node; &#x2F;&#x2F; help GC</span><br><span class="line">42:     &#125;</span><br><span class="line">43: &#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç‹¬å å¼è·å–å“åº”ä¸­æ–­"><a href="#ç‹¬å å¼è·å–å“åº”ä¸­æ–­" class="headerlink" title="ç‹¬å å¼è·å–å“åº”ä¸­æ–­"></a>ç‹¬å å¼è·å–å“åº”ä¸­æ–­</h5><p>AQS æä¾›äº†<code>acquire(int arg)</code> æ–¹æ³•ï¼Œä»¥ä¾›ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯è¯¥æ–¹æ³•<strong>å¯¹ä¸­æ–­ä¸å“åº”</strong>ï¼Œå¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œåï¼Œè¯¥çº¿ç¨‹ä¼šä¾ç„¶ä½äºCLHåŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ç€è·å–åŒæ­¥çŠ¶æ€ã€‚ä¸ºäº†<strong>å“åº”ä¸­æ–­</strong>ï¼ŒAQS æä¾›äº† <code>#acquireInterruptibly(int arg)</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•åœ¨ç­‰å¾…è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œä¼š<strong>ç«‹åˆ»</strong>å“åº”ä¸­æ–­ï¼Œå¹¶æŠ›å‡º InterruptedException å¼‚å¸¸ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireInterruptibly(int arg) throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    if (!tryAcquire(arg))</span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>é¦–å…ˆï¼Œæ ¡éªŒè¯¥çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­äº†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æŠ›å‡ºInterruptedException å¼‚å¸¸ã€‚</li>
<li>ç„¶åï¼Œè°ƒç”¨ <code>#tryAcquire(int arg)</code> æ–¹æ³•ï¼Œå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>æœ€åï¼Œè°ƒç”¨ <code>#doAcquireInterruptibly(int arg)</code> æ–¹æ³•ï¼Œè‡ªæ—‹ç›´åˆ°è·å¾—åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œ<strong>æˆ–çº¿ç¨‹ä¸­æ–­æŠ›å‡º InterruptedException å¼‚å¸¸</strong>ã€‚</li>
<li>åº”è¯¥ä¸ä»…ä»… help gc</li>
</ul>
<h6 id="doAcquireInterruptibly"><a href="#doAcquireInterruptibly" class="headerlink" title="doAcquireInterruptibly"></a>doAcquireInterruptibly</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private void doAcquireInterruptibly(int arg)</span><br><span class="line">    throws InterruptedException &#123;</span><br><span class="line">    final Node node &#x3D; addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    boolean failed &#x3D; true;</span><br><span class="line">    try &#123;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            final Node p &#x3D; node.predecessor();</span><br><span class="line">            if (p &#x3D;&#x3D; head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next &#x3D; null; &#x2F;&#x2F; help GC</span><br><span class="line">                failed &#x3D; false;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                throw new InterruptedException(); &#x2F;&#x2F; &lt;1&gt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒä¸ <code>#acquire(int arg)</code> æ–¹æ³•<strong>ä»…æœ‰ä¸¤ä¸ªå·®åˆ«</strong>ï¼š</p>
<ol>
<li>æ–¹æ³•å£°æ˜æŠ›å‡º InterruptedException å¼‚å¸¸ã€‚</li>
<li>åœ¨ä¸­æ–­æ–¹æ³•å¤„ä¸å†æ˜¯ä½¿ç”¨ <code>interrupted</code> æ ‡å¿—ï¼Œè€Œæ˜¯ç›´æ¥æŠ›å‡º InterruptedException å¼‚å¸¸ï¼Œå³ <code>&lt;1&gt;</code> å¤„ã€‚</li>
</ol>
<h5 id="ç‹¬å å¼è¶…æ—¶è·å–"><a href="#ç‹¬å å¼è¶…æ—¶è·å–" class="headerlink" title="ç‹¬å å¼è¶…æ—¶è·å–"></a>ç‹¬å å¼è¶…æ—¶è·å–</h5><p>AQS é™¤äº†æä¾›ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å¤–ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªå¢å¼ºç‰ˆçš„æ–¹æ³• <code>#tryAcquireNanos(int arg, long nanos)</code> ã€‚è¯¥æ–¹æ³•ä¸º <code>#acquireInterruptibly(int arg)</code> æ–¹æ³•çš„è¿›ä¸€æ­¥å¢å¼ºï¼Œå®ƒé™¤äº†å“åº”ä¸­æ–­å¤–ï¼Œè¿˜æœ‰<strong>è¶…æ—¶æ§åˆ¶</strong>ã€‚å³å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰åœ¨æŒ‡å®šæ—¶é—´å†…è·å–åŒæ­¥çŠ¶æ€ï¼Œåˆ™ä¼šè¿”å› false ï¼Œå¦åˆ™è¿”å› true ã€‚</p>
<p><strong>æµç¨‹å›¾</strong>å¦‚ä¸‹ï¼š</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120811002.png" alt="æµç¨‹å›¾"></p>
<p><strong>ä»£ç </strong>å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final boolean tryAcquireNanos(int arg, long nanosTimeout)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    return tryAcquire(arg) ||</span><br><span class="line">        doAcquireNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>é¦–å…ˆï¼Œæ ¡éªŒè¯¥çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­äº†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æŠ›å‡ºInterruptedException å¼‚å¸¸ã€‚</li>
<li>ç„¶åï¼Œè°ƒç”¨ <code>#tryAcquire(int arg)</code> æ–¹æ³•ï¼Œå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>æœ€åï¼Œè°ƒç”¨ <code>#tryAcquireNanos(int arg)</code> æ–¹æ³•ï¼Œè‡ªæ—‹ç›´åˆ°è·å¾—åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œæˆ–çº¿ç¨‹ä¸­æ–­æŠ›å‡º InterruptedException å¼‚å¸¸ï¼Œ<strong>æˆ–è¶…è¿‡æŒ‡å®šæ—¶é—´è¿”å›è·å–åŒæ­¥çŠ¶æ€å¤±è´¥</strong>ã€‚</li>
</ul>
<h6 id="tryAcquireNanos"><a href="#tryAcquireNanos" class="headerlink" title="tryAcquireNanos"></a>tryAcquireNanos</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">static final long spinForTimeoutThreshold &#x3D; 1000L;</span><br><span class="line"></span><br><span class="line">  1: private boolean doAcquireNanos(int arg, long nanosTimeout)</span><br><span class="line">  2:         throws InterruptedException &#123;</span><br><span class="line">  3:     &#x2F;&#x2F; nanosTimeout &lt;&#x3D; 0</span><br><span class="line">  4:     if (nanosTimeout &lt;&#x3D; 0L)</span><br><span class="line">  5:         return false;</span><br><span class="line">  6:     &#x2F;&#x2F; è¶…æ—¶æ—¶é—´</span><br><span class="line">  7:     final long deadline &#x3D; System.nanoTime() + nanosTimeout;</span><br><span class="line">  8:     &#x2F;&#x2F; æ–°å¢ Node èŠ‚ç‚¹</span><br><span class="line">  9:     final Node node &#x3D; addWaiter(Node.EXCLUSIVE);</span><br><span class="line"> 10:     boolean failed &#x3D; true;</span><br><span class="line"> 11:     try &#123;</span><br><span class="line"> 12:         &#x2F;&#x2F; è‡ªæ—‹</span><br><span class="line"> 13:         for (;;) &#123;</span><br><span class="line"> 14:             final Node p &#x3D; node.predecessor();</span><br><span class="line"> 15:             &#x2F;&#x2F; è·å–åŒæ­¥çŠ¶æ€æˆåŠŸ</span><br><span class="line"> 16:             if (p &#x3D;&#x3D; head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line"> 17:                 setHead(node);</span><br><span class="line"> 18:                 p.next &#x3D; null; &#x2F;&#x2F; help GC</span><br><span class="line"> 19:                 failed &#x3D; false;</span><br><span class="line"> 20:                 return true;</span><br><span class="line"> 21:             &#125;</span><br><span class="line"> 22:             &#x2F;*</span><br><span class="line"> 23:              * è·å–å¤±è´¥ï¼Œåšè¶…æ—¶ã€ä¸­æ–­åˆ¤æ–­</span><br><span class="line"> 24:              *&#x2F;</span><br><span class="line"> 25:             &#x2F;&#x2F; é‡æ–°è®¡ç®—éœ€è¦ä¼‘çœ çš„æ—¶é—´</span><br><span class="line"> 26:             nanosTimeout &#x3D; deadline - System.nanoTime();</span><br><span class="line"> 27:             &#x2F;&#x2F; å·²ç»è¶…æ—¶ï¼Œè¿”å›false</span><br><span class="line"> 28:             if (nanosTimeout &lt;&#x3D; 0L)</span><br><span class="line"> 29:                 return false;</span><br><span class="line"> 30:             &#x2F;&#x2F; å¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œåˆ™ç­‰å¾…nanosTimeoutçº³ç§’</span><br><span class="line"> 31:             &#x2F;&#x2F; æ³¨ï¼šè¯¥çº¿ç¨‹ä¼šç›´æ¥ä»LockSupport.parkNanosä¸­è¿”å›ï¼Œ</span><br><span class="line"> 32:             &#x2F;&#x2F; LockSupport ä¸º J.U.C æä¾›çš„ä¸€ä¸ªé˜»å¡å’Œå”¤é†’çš„å·¥å…·ç±»ï¼Œåé¢åšè¯¦ç»†ä»‹ç»</span><br><span class="line"> 33:             if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line"> 34:                     nanosTimeout &gt; spinForTimeoutThreshold)</span><br><span class="line"> 35:                 LockSupport.parkNanos(this, nanosTimeout);</span><br><span class="line"> 36:             &#x2F;&#x2F; çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­äº†</span><br><span class="line"> 37:             if (Thread.interrupted())</span><br><span class="line"> 38:                 throw new InterruptedException();</span><br><span class="line"> 39:         &#125;</span><br><span class="line"> 40:     &#125; finally &#123;</span><br><span class="line"> 41:         if (failed)</span><br><span class="line"> 42:             cancelAcquire(node);</span><br><span class="line"> 43:     &#125;</span><br><span class="line"> 44: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å› ä¸ºæ˜¯åœ¨ <code>#doAcquireInterruptibly(int arg)</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œåšäº†<strong>è¶…æ—¶</strong>æ§åˆ¶çš„å¢å¼ºï¼Œæ‰€ä»¥<strong>ç›¸åŒéƒ¨åˆ†ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡</strong>ã€‚</li>
<li>ç¬¬ 3 è‡³ 5 è¡Œï¼šå¦‚æœè¶…æ—¶æ—¶é—´å°äº 0 ï¼Œç›´æ¥è¿”å› false ï¼Œå·²ç»è¶…æ—¶ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šè®¡ç®—æœ€ç»ˆè¶…æ—¶æ—¶é—´ <code>deadline</code> ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
<li>ç¬¬ 10 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
<li>ç¬¬ 13 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
<li>ç¬¬ 14 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
<li>ç¬¬ 15 è‡³ 21 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
<li>ç¬¬ 26 è¡Œï¼šé‡æ–°è®¡ç®—<strong>å‰©ä½™</strong>å¯è·å–åŒæ­¥çŠ¶æ€çš„æ—¶é—´ <code>nanosTimeout</code> ã€‚</li>
<li>ç¬¬ 27 è‡³ 29 è¡Œï¼šå¦‚æœå‰©ä½™æ—¶é—´å°äº 0 ï¼Œç›´æ¥è¿”å› false ï¼Œå·²ç»è¶…æ—¶ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
<li>ç¬¬ 34 è‡³ 35 è¡Œï¼šå¦‚æœå‰©ä½™æ—¶é—´å¤§äº <code>spinForTimeoutThreshold</code> ï¼Œåˆ™è°ƒç”¨ <code>LockSupport#parkNanos(Object blocker, long nanos)</code> æ–¹æ³•ï¼Œä¼‘çœ  <code>nanosTimeout</code> <strong>çº³</strong>ç§’ã€‚å¦åˆ™ï¼Œå°±ä¸éœ€è¦ä¼‘çœ äº†ï¼Œç›´æ¥è¿›å…¥<strong>å¿«é€Ÿè‡ªæ—‹</strong>çš„è¿‡ç¨‹ã€‚åŸå› åœ¨äºï¼Œ<code>spinForTimeoutThreshold</code> å·²ç»éå¸¸å°äº†ï¼Œ<strong>éå¸¸çŸ­çš„æ—¶é—´ç­‰å¾…æ— æ³•åšåˆ°ååˆ†ç²¾ç¡®</strong>ï¼Œå¦‚æœè¿™æ—¶å†æ¬¡è¿›è¡Œè¶…æ—¶ç­‰å¾…ï¼Œç›¸åä¼šè®© <code>nanosTimeout</code> çš„è¶…æ—¶ä»æ•´ä½“ä¸Šé¢è¡¨ç°å¾—ä¸æ˜¯é‚£ä¹ˆç²¾ç¡®ã€‚<strong>æ‰€ä»¥ï¼Œåœ¨è¶…æ—¶éå¸¸çŸ­çš„åœºæ™¯ä¸­ï¼ŒAQS ä¼šè¿›è¡Œæ— æ¡ä»¶çš„å¿«é€Ÿè‡ªæ—‹</strong>ã€‚</li>
<li>ç¬¬ 36 è‡³ 39 è¡Œï¼šè‹¥çº¿ç¨‹å·²ç»ä¸­æ–­äº†ï¼ŒæŠ›å‡º InterruptedException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 40 è‡³ 43 è¡Œï¼šã€ç›¸åŒï¼Œè·³è¿‡ã€‘</li>
</ul>
<h5 id="ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"><a href="#ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾" class="headerlink" title="ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"></a>ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾</h5><p>å½“çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€åï¼Œæ‰§è¡Œå®Œç›¸åº”é€»è¾‘åï¼Œå°±éœ€è¦<strong>é‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€‚AQS æä¾›äº†<code>#release(int arg)</code>æ–¹æ³•ï¼Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1: public final boolean release(int arg) &#123;</span><br><span class="line">2:     if (tryRelease(arg)) &#123;</span><br><span class="line">3:         Node h &#x3D; head;</span><br><span class="line">4:         if (h !&#x3D; null &amp;&amp; h.waitStatus !&#x3D; 0)</span><br><span class="line">5:             unparkSuccessor(h);</span><br><span class="line">6:         return true;</span><br><span class="line">7:     &#125;</span><br><span class="line">8:     return false;</span><br><span class="line">9: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 2 è¡Œï¼šè°ƒç”¨ <code>#tryRelease(int arg)</code> æ–¹æ³•ï¼Œå»å°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé‡Šæ”¾æˆåŠŸåˆ™è®¾ç½®é”çŠ¶æ€å¹¶è¿”å› true ï¼Œå¦åˆ™è·å–å¤±è´¥ï¼Œè¿”å› false ã€‚åŒæ—¶ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”ã€ç¬¬ 3 è‡³ 6ã€‘å’Œã€ç¬¬ 8 è¡Œã€‘çš„é€»è¾‘ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šè·å¾—<strong>å½“å‰</strong>çš„ <code>head</code> ï¼Œé¿å…å¹¶å‘é—®é¢˜ã€‚</li>
</ul>
<h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>è¿™é‡Œç¨å¾®æ€»ç»“ä¸‹ï¼š</p>
<blockquote>
<p>åœ¨ AQS ä¸­ç»´æŠ¤ç€ä¸€ä¸ª FIFO çš„åŒæ­¥é˜Ÿåˆ—ã€‚</p>
<ul>
<li>å½“çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åï¼Œåˆ™ä¼šåŠ å…¥åˆ°è¿™ä¸ª CLH åŒæ­¥é˜Ÿåˆ—çš„å¯¹å°¾ï¼Œå¹¶ä¸€ç›´ä¿æŒç€è‡ªæ—‹ã€‚</li>
<li>åœ¨ CLH åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹åœ¨è‡ªæ—‹æ—¶ï¼Œä¼šåˆ¤æ–­å…¶å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºé¦–èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºé¦–èŠ‚ç‚¹åˆ™ä¸æ–­å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–æˆåŠŸåˆ™é€€å‡ºCLHåŒæ­¥é˜Ÿåˆ—ã€‚</li>
<li>å½“çº¿ç¨‹æ‰§è¡Œå®Œé€»è¾‘åï¼Œä¼šé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé‡Šæ”¾åä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ã€‚</li>
</ul>
</blockquote>
<h4 id="å…±äº«å¼"><a href="#å…±äº«å¼" class="headerlink" title="å…±äº«å¼"></a>å…±äº«å¼</h4><p>å…±äº«å¼ä¸ç‹¬å å¼çš„æœ€ä¸»è¦åŒºåˆ«åœ¨äºï¼Œ<strong>åŒä¸€æ—¶åˆ»</strong>ï¼š</p>
<ul>
<li>ç‹¬å å¼åªèƒ½æœ‰<strong>ä¸€ä¸ª</strong>çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ã€‚</li>
<li>å…±äº«å¼å¯ä»¥æœ‰<strong>å¤šä¸ª</strong>çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼Œè¯»æ“ä½œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œï¼Œè€Œå†™æ“ä½œåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå†™æ“ä½œï¼Œå…¶ä»–æ“ä½œéƒ½ä¼šè¢«é˜»å¡ã€‚å‚è§ ReentrantReadWriteLock ã€‚</p>
<h5 id="å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–"><a href="#å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–" class="headerlink" title="å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–"></a>å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–</h5><p>AQS æä¾› <code>#acquireShared(int arg)</code> æ–¹æ³•ï¼Œå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><code>#acquireShared(int arg)</code> æ–¹æ³•ï¼Œå¯¹æ ‡ <code>#acquire(int arg)</code> æ–¹æ³•ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1: public final void acquireShared(int arg) &#123;</span><br><span class="line">2:     if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">3:         doAcquireShared(arg);</span><br><span class="line">4: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 2 è¡Œï¼šè°ƒç”¨ <code>#tryAcquireShared(int arg)</code> æ–¹æ³•ï¼Œå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè·å–æˆåŠŸåˆ™è®¾ç½®é”çŠ¶æ€å¹¶è¿”å›å¤§äºç­‰äº 0 ï¼Œå¦åˆ™è·å–å¤±è´¥ï¼Œè¿”å›å°äº 0 ã€‚è‹¥è·å–æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œ<strong>ä¸ç”¨çº¿ç¨‹é˜»å¡</strong>ï¼Œè‡ªæ—‹ç›´åˆ°è·å¾—åŒæ­¥çŠ¶æ€æˆåŠŸã€‚</li>
</ul>
<h6 id="doAcquireShared"><a href="#doAcquireShared" class="headerlink" title="doAcquireShared"></a>doAcquireShared</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> 1: private void doAcquireShared(int arg) &#123;</span><br><span class="line"> 2:     &#x2F;&#x2F; å…±äº«å¼èŠ‚ç‚¹</span><br><span class="line"> 3:     final Node node &#x3D; addWaiter(Node.SHARED);</span><br><span class="line"> 4:     boolean failed &#x3D; true;</span><br><span class="line"> 5:     try &#123;</span><br><span class="line"> 6:         boolean interrupted &#x3D; false;</span><br><span class="line"> 7:         for (;;) &#123;</span><br><span class="line"> 8:             &#x2F;&#x2F; å‰é©±èŠ‚ç‚¹</span><br><span class="line"> 9:             final Node p &#x3D; node.predecessor();</span><br><span class="line">10:             &#x2F;&#x2F; å¦‚æœå…¶å‰é©±èŠ‚ç‚¹ï¼Œè·å–åŒæ­¥çŠ¶æ€</span><br><span class="line">11:             if (p &#x3D;&#x3D; head) &#123;</span><br><span class="line">12:                 &#x2F;&#x2F; å°è¯•è·å–åŒæ­¥</span><br><span class="line">13:                 int r &#x3D; tryAcquireShared(arg);</span><br><span class="line">14:                 if (r &gt;&#x3D; 0) &#123;</span><br><span class="line">15:                     setHeadAndPropagate(node, r);</span><br><span class="line">16:                     p.next &#x3D; null; &#x2F;&#x2F; help GC</span><br><span class="line">17:                     if (interrupted)</span><br><span class="line">18:                         selfInterrupt();</span><br><span class="line">19:                     failed &#x3D; false;</span><br><span class="line">20:                     return;</span><br><span class="line">21:                 &#125;</span><br><span class="line">22:             &#125;</span><br><span class="line">23:             if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">24:                     parkAndCheckInterrupt())</span><br><span class="line">25:                 interrupted &#x3D; true;</span><br><span class="line">26:         &#125;</span><br><span class="line">27:     &#125; finally &#123;</span><br><span class="line">28:         if (failed)</span><br><span class="line">29:             cancelAcquire(node);</span><br><span class="line">30:     &#125;</span><br><span class="line">31: &#125;</span><br></pre></td></tr></table></figure>

<h6 id="setHeadAndPropagate"><a href="#setHeadAndPropagate" class="headerlink" title="setHeadAndPropagate"></a>setHeadAndPropagate</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> 1: private void setHeadAndPropagate(Node node, int propagate) &#123;</span><br><span class="line"> 2:     Node h &#x3D; head; &#x2F;&#x2F; Record old head for check below</span><br><span class="line"> 3:     setHead(node);</span><br><span class="line"> 4:     &#x2F;*</span><br><span class="line"> 5:      * Try to signal next queued node if:</span><br><span class="line"> 6:      *   Propagation was indicated by caller,</span><br><span class="line"> 7:      *     or was recorded (as h.waitStatus either before</span><br><span class="line"> 8:      *     or after setHead) by a previous operation</span><br><span class="line"> 9:      *     (note: this uses sign-check of waitStatus because</span><br><span class="line">10:      *      PROPAGATE status may transition to SIGNAL.)</span><br><span class="line">11:      * and</span><br><span class="line">12:      *   The next node is waiting in shared mode,</span><br><span class="line">13:      *     or we don&#39;t know, because it appears null</span><br><span class="line">14:      *</span><br><span class="line">15:      * The conservatism in both of these checks may cause</span><br><span class="line">16:      * unnecessary wake-ups, but only when there are multiple</span><br><span class="line">17:      * racing acquires&#x2F;releases, so most need signals now or soon</span><br><span class="line">18:      * anyway.</span><br><span class="line">19:      *&#x2F;</span><br><span class="line">20:     if (propagate &gt; 0 || h &#x3D;&#x3D; null || h.waitStatus &lt; 0 ||</span><br><span class="line">21:         (h &#x3D; head) &#x3D;&#x3D; null || h.waitStatus &lt; 0) &#123;</span><br><span class="line">22:         Node s &#x3D; node.next;</span><br><span class="line">23:         if (s &#x3D;&#x3D; null || s.isShared())</span><br><span class="line">24:             doReleaseShared();</span><br><span class="line">25:     &#125;</span><br><span class="line">26: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 2 è¡Œï¼šè®°å½•<strong>åŸæ¥</strong>çš„<strong>é¦–</strong>èŠ‚ç‚¹ <code>h</code> ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#setHead(Node node)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>node</code> ä¸º<strong>æ–°</strong>çš„<strong>é¦–</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼š<code>propagate &gt; 0</code> ä»£ç å—ï¼Œè¯´æ˜åŒæ­¥çŠ¶æ€è¿˜èƒ½è¢«å…¶ä»–çº¿ç¨‹è·å–ã€‚</li>
<li>ç¬¬ 20 è‡³ 21 è¡Œï¼šåˆ¤æ–­<strong>åŸæ¥</strong>çš„æˆ–è€…<strong>æ–°</strong>çš„<strong>é¦–</strong>èŠ‚ç‚¹ï¼Œ<strong>ç­‰å¾…çŠ¶æ€</strong>ä¸º <code>Node.PROPAGATE</code> æˆ–è€… <code>Node.SIGNAL</code> æ—¶ï¼Œå¯ä»¥ç»§ç»­å‘ä¸‹<strong>å”¤é†’</strong>ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼šè°ƒç”¨ <code>Node#isShared()</code> æ–¹æ³•ï¼Œåˆ¤æ–­<strong>ä¸‹</strong>ä¸€ä¸ªèŠ‚ç‚¹ä¸º<strong>å…±äº«å¼</strong>è·å–åŒæ­¥çŠ¶æ€ã€‚</li>
<li>ç¬¬ 24 è¡Œï¼šè°ƒç”¨ <code>#doReleaseShared()</code> æ–¹æ³•ï¼Œå”¤é†’åç»­çš„<strong>å…±äº«å¼</strong>è·å–åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ã€‚</li>
</ul>
<h5 id="å…±äº«å¼è·å–å“åº”ä¸­æ–­"><a href="#å…±äº«å¼è·å–å“åº”ä¸­æ–­" class="headerlink" title="å…±äº«å¼è·å–å“åº”ä¸­æ–­"></a>å…±äº«å¼è·å–å“åº”ä¸­æ–­</h5><p><code>#acquireSharedInterruptibly(int arg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireSharedInterruptibly(int arg)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void doAcquireSharedInterruptibly(int arg)</span><br><span class="line">    throws InterruptedException &#123;</span><br><span class="line">    final Node node &#x3D; addWaiter(Node.SHARED);</span><br><span class="line">    boolean failed &#x3D; true;</span><br><span class="line">    try &#123;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            final Node p &#x3D; node.predecessor();</span><br><span class="line">            if (p &#x3D;&#x3D; head) &#123;</span><br><span class="line">                int r &#x3D; tryAcquireShared(arg);</span><br><span class="line">                if (r &gt;&#x3D; 0) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next &#x3D; null; &#x2F;&#x2F; help GC</span><br><span class="line">                    failed &#x3D; false;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                throw new InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å…±äº«å¼è¶…æ—¶è·å–"><a href="#å…±äº«å¼è¶…æ—¶è·å–" class="headerlink" title="å…±äº«å¼è¶…æ—¶è·å–"></a>å…±äº«å¼è¶…æ—¶è·å–</h5><p><code>#tryAcquireSharedNanos(int arg, long nanosTimeout)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    return tryAcquireShared(arg) &gt;&#x3D; 0 ||</span><br><span class="line">        doAcquireSharedNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private boolean doAcquireSharedNanos(int arg, long nanosTimeout)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (nanosTimeout &lt;&#x3D; 0L)</span><br><span class="line">        return false;</span><br><span class="line">    final long deadline &#x3D; System.nanoTime() + nanosTimeout;</span><br><span class="line">    final Node node &#x3D; addWaiter(Node.SHARED);</span><br><span class="line">    boolean failed &#x3D; true;</span><br><span class="line">    try &#123;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            final Node p &#x3D; node.predecessor();</span><br><span class="line">            if (p &#x3D;&#x3D; head) &#123;</span><br><span class="line">                int r &#x3D; tryAcquireShared(arg);</span><br><span class="line">                if (r &gt;&#x3D; 0) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next &#x3D; null; &#x2F;&#x2F; help GC</span><br><span class="line">                    failed &#x3D; false;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            nanosTimeout &#x3D; deadline - System.nanoTime();</span><br><span class="line">            if (nanosTimeout &lt;&#x3D; 0L)</span><br><span class="line">                return false;</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                nanosTimeout &gt; spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(this, nanosTimeout);</span><br><span class="line">            if (Thread.interrupted())</span><br><span class="line">                throw new InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"><a href="#å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾" class="headerlink" title="å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾"></a>å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾</h5><p>å½“çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€åï¼Œæ‰§è¡Œå®Œç›¸åº”é€»è¾‘åï¼Œå°±éœ€è¦<strong>é‡Šæ”¾åŒæ­¥çŠ¶æ€</strong>ã€‚AQS æä¾›äº†<code>#releaseShared(int arg)</code>æ–¹æ³•ï¼Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1: public final boolean releaseShared(int arg) &#123;</span><br><span class="line">2:     if (tryReleaseShared(arg)) &#123;</span><br><span class="line">3:         doReleaseShared();</span><br><span class="line">4:         return true;</span><br><span class="line">5:     &#125;</span><br><span class="line">6:     return false;</span><br><span class="line">7: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 2 è¡Œï¼šè°ƒç”¨ <code>#tryReleaseShared(int arg)</code> æ–¹æ³•ï¼Œå»å°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œé‡Šæ”¾æˆåŠŸåˆ™è®¾ç½®é”çŠ¶æ€å¹¶è¿”å› true ï¼Œå¦åˆ™è·å–å¤±è´¥ï¼Œè¿”å› false ã€‚åŒæ—¶ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”ã€ç¬¬ 3 è‡³ 5ã€‘å’Œã€ç¬¬ 6 è¡Œã€‘çš„é€»è¾‘ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#doReleaseShared()</code> æ–¹æ³•ï¼Œå”¤é†’åç»­çš„<strong>å…±äº«å¼</strong>è·å–åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ã€‚</li>
</ul>
<h6 id="doReleaseShared"><a href="#doReleaseShared" class="headerlink" title="doReleaseShared"></a>doReleaseShared</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> 1: private void doReleaseShared() &#123;</span><br><span class="line"> 2:     &#x2F;*</span><br><span class="line"> 3:      * Ensure that a release propagates, even if there are other</span><br><span class="line"> 4:      * in-progress acquires&#x2F;releases.  This proceeds in the usual</span><br><span class="line"> 5:      * way of trying to unparkSuccessor of head if it needs</span><br><span class="line"> 6:      * signal. But if it does not, status is set to PROPAGATE to</span><br><span class="line"> 7:      * ensure that upon release, propagation continues.</span><br><span class="line"> 8:      * Additionally, we must loop in case a new node is added</span><br><span class="line"> 9:      * while we are doing this. Also, unlike other uses of</span><br><span class="line">10:      * unparkSuccessor, we need to know if CAS to reset status</span><br><span class="line">11:      * fails, if so rechecking.</span><br><span class="line">12:      *&#x2F;</span><br><span class="line">13:     for (;;) &#123;</span><br><span class="line">14:         Node h &#x3D; head;</span><br><span class="line">15:         if (h !&#x3D; null &amp;&amp; h !&#x3D; tail) &#123;</span><br><span class="line">16:             int ws &#x3D; h.waitStatus;</span><br><span class="line">17:             if (ws &#x3D;&#x3D; Node.SIGNAL) &#123;</span><br><span class="line">18:                 if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))</span><br><span class="line">19:                     continue;            &#x2F;&#x2F; loop to recheck cases</span><br><span class="line">20:                 unparkSuccessor(h);</span><br><span class="line">21:             &#125;</span><br><span class="line">22:             else if (ws &#x3D;&#x3D; 0 &amp;&amp;</span><br><span class="line">23:                      !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))</span><br><span class="line">24:                 continue;                &#x2F;&#x2F; loop on failed CAS</span><br><span class="line">25:         &#125;</span><br><span class="line">26:         if (h &#x3D;&#x3D; head)                   &#x2F;&#x2F; loop if head changed</span><br><span class="line">27:             break;</span><br><span class="line">28:     &#125;</span><br><span class="line">29: &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹"><a href="#AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹" class="headerlink" title="AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹"></a>AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹</h3><h4 id="parkAndCheckInterrupt"><a href="#parkAndCheckInterrupt" class="headerlink" title="parkAndCheckInterrupt"></a>parkAndCheckInterrupt</h4><p>åœ¨çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™åŠ å…¥ CLH åŒæ­¥é˜Ÿåˆ—ï¼Œé€šè¿‡é€šè¿‡è‡ªæ—‹çš„æ–¹å¼ä¸æ–­è·å–åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­ï¼Œåˆ™éœ€è¦åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦é˜»å¡ï¼Œå…¶ä¸»è¦æ–¹æ³•åœ¨<code>acquireQueued(int arg)</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ... çœç•¥å‰é¢æ— å…³ä»£ç </span><br><span class="line"></span><br><span class="line">if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                    interrupted &#x3D; true;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ... çœç•¥å‰é¢æ— å…³ä»£ç </span><br></pre></td></tr></table></figure>

<ul>
<li><p>åœ¨è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯ç«‹é©¬è¿›è¡Œé˜»å¡ï¼Œéœ€è¦æ£€æŸ¥è¯¥çº¿ç¨‹çš„çŠ¶æ€ï¼Œæ£€æŸ¥çŠ¶æ€çš„æ–¹æ³•ä¸º <code>#shouldParkAfterFailedAcquire(Node pred, Node node)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦é å‰é©±èŠ‚ç‚¹åˆ¤æ–­å½“å‰çº¿ç¨‹<strong>æ˜¯å¦åº”è¯¥è¢«é˜»å¡</strong>ã€‚</p>
</li>
<li><p>å¦‚æœ <code>#shouldParkAfterFailedAcquire(Node pred, Node node)</code> æ–¹æ³•è¿”å› <strong>true</strong> ï¼Œåˆ™è°ƒç”¨<code>parkAndCheckInterrupt()</code> æ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private final boolean parkAndCheckInterrupt() &#123;</span><br><span class="line">    LockSupport.park(this);</span><br><span class="line">    return Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œåœ¨çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œè°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread#interrupted()</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•ï¼Œè¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œå¹¶æ¸…ç†æ‰“æ–­çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šï¼Œçº¿ç¨‹è¢«å”¤é†’</p>
<p>æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼Œå½“å‰èŠ‚ç‚¹(çº¿ç¨‹)çš„<strong>å‰åºèŠ‚ç‚¹</strong>é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå”¤é†’äº†è¯¥çº¿ç¨‹ã€‚</li>
<li>ç¬¬äºŒç§ï¼Œå½“å‰çº¿ç¨‹è¢«æ‰“æ–­å¯¼è‡´å”¤é†’ã€‚</li>
</ul>
</li>
</ul>
<h4 id="unparkSuccessor"><a href="#unparkSuccessor" class="headerlink" title="unparkSuccessor"></a>unparkSuccessor</h4><p>å½“çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œåˆ™éœ€è¦å”¤é†’è¯¥çº¿ç¨‹çš„åç»§èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final boolean release(int arg) &#123;</span><br><span class="line">    if (tryRelease(arg)) &#123;</span><br><span class="line">        Node h &#x3D; head;</span><br><span class="line">        if (h !&#x3D; null &amp;&amp; h.waitStatus !&#x3D; 0)</span><br><span class="line">            unparkSuccessor(h); &#x2F;&#x2F; å”¤é†’åç»§èŠ‚ç‚¹</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>è°ƒç”¨ <code>unparkSuccessor(Node node)</code> æ–¹æ³•ï¼Œå”¤é†’<strong>åç»§</strong>èŠ‚ç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">private void unparkSuccessor(Node node) &#123;</span><br><span class="line">    &#x2F;&#x2F;å½“å‰èŠ‚ç‚¹çŠ¶æ€</span><br><span class="line">    int ws &#x3D; node.waitStatus;</span><br><span class="line">    &#x2F;&#x2F;å½“å‰çŠ¶æ€ &lt; 0 åˆ™è®¾ç½®ä¸º 0</span><br><span class="line">    if (ws &lt; 0)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, 0);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span><br><span class="line">    Node s &#x3D; node.next;</span><br><span class="line">    &#x2F;&#x2F;åç»§èŠ‚ç‚¹ä¸ºnullæˆ–è€…å…¶çŠ¶æ€ &gt; 0 (è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­äº†)</span><br><span class="line">    if (s &#x3D;&#x3D; null || s.waitStatus &gt; 0) &#123;</span><br><span class="line">        s &#x3D; null;</span><br><span class="line">        &#x2F;&#x2F;ä»tailèŠ‚ç‚¹æ¥æ‰¾å¯ç”¨èŠ‚ç‚¹</span><br><span class="line">        for (Node t &#x3D; tail; t !&#x3D; null &amp;&amp; t !&#x3D; node; t &#x3D; t.prev)</span><br><span class="line">            if (t.waitStatus &lt;&#x3D; 0)</span><br><span class="line">                s &#x3D; t;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;å”¤é†’åç»§èŠ‚ç‚¹</span><br><span class="line">    if (s !&#x3D; null)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¯èƒ½ä¼šå­˜åœ¨å½“å‰çº¿ç¨‹çš„<strong>åç»§</strong>èŠ‚ç‚¹ä¸º <code>null</code>ï¼Œä¾‹å¦‚ï¼šè¶…æ—¶ã€è¢«ä¸­æ–­çš„æƒ…å†µã€‚å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µäº†ï¼Œåˆ™éœ€è¦è·³è¿‡è¯¥èŠ‚ç‚¹ã€‚<ul>
<li>ä½†æ˜¯ï¼Œä¸ºä½•æ˜¯ä» <code>tail</code> å°¾èŠ‚ç‚¹å¼€å§‹ï¼Œè€Œä¸æ˜¯ä» <code>node.next</code> å¼€å§‹å‘¢ï¼ŸåŸå› åœ¨äºï¼Œå–æ¶ˆçš„ <code>node.next.next</code> æŒ‡å‘çš„æ˜¯ <code>node.next</code> è‡ªå·±ã€‚å¦‚æœé¡ºåºéå†ä¸‹å»ï¼Œä¼šå¯¼è‡´<strong>æ­»å¾ªç¯</strong>ã€‚æ‰€ä»¥æ­¤æ—¶ï¼Œ<strong>åªèƒ½</strong>é‡‡ç”¨ <code>tail</code> å›æº¯çš„åŠæ³•ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ª( ä¸æ˜¯<strong>æœ€æ–°</strong>æ‰¾åˆ°çš„ï¼Œè€Œæ˜¯<strong>æœ€å‰åºçš„</strong> )å¯ç”¨çš„çº¿ç¨‹ã€‚</li>
<li>å†ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆå–æ¶ˆçš„ <code>node.next.next</code> æŒ‡å‘çš„æ˜¯ <code>node.next</code> è‡ªå·±å‘¢ï¼Ÿåœ¨ <code>#cancelAcquire(Node node)</code> çš„æœ«å°¾ï¼Œ<code>node.next = node;</code> ä»£ç å—ï¼Œå–æ¶ˆçš„ <code>node</code> èŠ‚ç‚¹ï¼Œå°†å…¶ <code>next</code> æŒ‡å‘äº†è‡ªå·±ã€‚</li>
</ul>
</li>
<li>æœ€åï¼Œè°ƒç”¨ <code>LockSupportçš„unpark(Thread thread)</code> æ–¹æ³•ï¼Œå”¤é†’è¯¥çº¿ç¨‹ã€‚</li>
</ul>
</li>
</ul>
<h4 id="LockSupport"><a href="#LockSupport" class="headerlink" title="LockSupport"></a>LockSupport</h4><p>ä»ä¸Šé¢æˆ‘å¯ä»¥çœ‹åˆ°ï¼Œå½“éœ€è¦é˜»å¡æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼ŒAQS éƒ½æ˜¯ä½¿ç”¨ LockSupport è¿™ä¸ªå·¥å…·ç±»æ¥å®Œæˆçš„ã€‚</p>
<blockquote>
<p>LockSupport æ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚</p>
</blockquote>
<p>æ¯ä¸ªä½¿ç”¨ LockSupport çš„çº¿ç¨‹éƒ½ä¼šä¸ä¸€ä¸ªè®¸å¯ä¸ä¹‹å…³è”ï¼š</p>
<ul>
<li>å¦‚æœè¯¥è®¸å¯å¯ç”¨ï¼Œå¹¶ä¸”å¯åœ¨è¿›ç¨‹ä¸­ä½¿ç”¨ï¼Œåˆ™è°ƒç”¨ <code>#park(...)</code> å°†ä¼šç«‹å³è¿”å›ï¼Œå¦åˆ™å¯èƒ½é˜»å¡ã€‚</li>
<li>å¦‚æœè®¸å¯å°šä¸å¯ç”¨ï¼Œåˆ™å¯ä»¥è°ƒç”¨ <code>#unpark(...)</code> ä½¿å…¶å¯ç”¨ã€‚</li>
<li>ä½†æ˜¯ï¼Œæ³¨æ„è®¸å¯<strong>ä¸å¯é‡å…¥</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½è°ƒç”¨ä¸€æ¬¡ <code>park(...)</code> æ–¹æ³•ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ã€‚</li>
</ul>
<p>LockSupport å®šä¹‰äº†ä¸€ç³»åˆ—ä»¥ <code>park</code> å¼€å¤´çš„æ–¹æ³•æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œ<code>unpark(Thread thread)</code> æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://gitee.com/chenssy/blog-home/raw/master/image/sijava/2018120812001.png" alt="æ–¹æ³•"></p>
<ul>
<li><code>park(Object blocker)</code> æ–¹æ³•çš„blockerå‚æ•°ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸»è¦ç”¨äº<strong>é—®é¢˜æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§</strong>ã€‚</li>
<li>park æ–¹æ³•å’Œ <code>unpark(Thread thread)</code> æ–¹æ³•ï¼Œéƒ½æ˜¯<strong>æˆå¯¹å‡ºç°</strong>çš„ã€‚åŒæ—¶ <code>unpark(Thread thread)</code> æ–¹æ³•ï¼Œå¿…é¡»è¦åœ¨ park æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡Œã€‚å½“ç„¶ï¼Œå¹¶ä¸æ˜¯è¯´æ²¡æœ‰è°ƒç”¨ <code>unpark(Thread thread)</code> æ–¹æ³•çš„çº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ï¼Œpark æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒæ˜¯å¸¦äº†æ—¶é—´æˆ³çš„ <code>#parkNanos(long nanos)</code> æ–¹æ³•ï¼šä¸ºäº†çº¿ç¨‹è°ƒåº¦ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œæœ€å¤šç­‰å¾…æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œé™¤éè®¸å¯å¯ç”¨ã€‚</li>
</ul>
<h4 id="park"><a href="#park" class="headerlink" title="park"></a>park</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static void park() &#123;</span><br><span class="line">    UNSAFE.park(false, 0L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="unpark"><a href="#unpark" class="headerlink" title="unpark"></a>unpark</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void unpark(Thread thread) &#123;</span><br><span class="line">    if (thread !&#x3D; null)</span><br><span class="line">        UNSAFE.unpark(thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>å†…éƒ¨çš„å®ç°éƒ½æ˜¯é€šè¿‡ <code>sun.misc.Unsafe</code> æ¥å®ç°çš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; UNSAFE.java</span><br><span class="line">public native void park(boolean var1, long var2);</span><br><span class="line">public native void unpark(Object var1);</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªéƒ½æ˜¯ <code>native</code> æœ¬åœ°æ–¹æ³•ã€‚Unsafe æ˜¯ä¸€ä¸ªæ¯”è¾ƒå±é™©çš„ç±»ï¼Œä¸»è¦æ˜¯ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨çš„æ–¹æ³•é›†åˆã€‚å°½ç®¡è¿™ä¸ªç±»å’Œæ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯å…¬å¼€çš„ï¼ˆä½¿ç”¨ <code>public</code> è¿›è¡Œä¿®é¥°ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªç±»çš„ä½¿ç”¨ä»ç„¶å—é™ï¼Œä½ æ— æ³•åœ¨è‡ªå·±çš„ Java ç¨‹åºä¸­ç›´æ¥ä½¿ç”¨è¯¥ç±»ï¼Œå› ä¸ºåªæœ‰æˆä¿¡çš„ä»£ç æ‰èƒ½è·å¾—è¯¥ç±»çš„å®ä¾‹ã€‚</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81/">æºç </a></div><div class="post_share"><div class="social-share" data-image="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-39em6d.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/kele.png" target="_blank"><img class="post-qr-code-img" src="/img/kele.png" alt="è§‰å¾—è¿˜ä¸é”™ï¼Œè¯·ä»–å–ä¸€ç“¶å¯ä¹"/></a><div class="post-qr-code-desc">è§‰å¾—è¿˜ä¸é”™ï¼Œè¯·ä»–å–ä¸€ç“¶å¯ä¹</div></li><li class="reward-item"><a href="/img/ali.jpg" target="_blank"><img class="post-qr-code-img" src="/img/ali.jpg" alt="é›ªç¢§ä¹Ÿæ˜¯å¯ä»¥çš„"/></a><div class="post-qr-code-desc">é›ªç¢§ä¹Ÿæ˜¯å¯ä»¥çš„</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/07/%E4%BB%80%E4%B9%88%E6%98%AFspring%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><img class="prev-cover" src="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-6oj73l.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ä»€ä¹ˆæ˜¯springå¾ªç¯ä¾èµ–?æºç åˆ†æ</div></div></a></div><div class="next-post pull-right"><a href="/2021/03/03/Github%E9%AA%9A%E6%93%8D%E4%BD%9C/"><img class="next-cover" src="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-6oj73l.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Githubéªšæ“ä½œ</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2020/07/09/ä»€ä¹ˆæ˜¯CASåŸç†/" title="ä»€ä¹ˆæ˜¯CAS"><img class="cover" src="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-39em6d.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-09</div><div class="title">ä»€ä¹ˆæ˜¯CAS</div></div></a></div><div><a href="/2022/05/08/æ‰‹å†™mybatisç¬¬å››ç¯‡/" title="æ‰‹å†™mybatisç¬¬å››ç¯‡"><img class="cover" src="https://zzc-sso.oss-cn-hangzhou.aliyuncs.com/bolg/wallhaven-pk8l5m.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-08</div><div class="title">æ‰‹å†™mybatisç¬¬å››ç¯‡</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/tx2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">ç« å¿—æˆ</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">44</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">16</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/gump12138"><i class="fab fa-github"></i><span>å…³æ³¨æˆ‘</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cooper12138" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:994739211@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>å…¬å‘Š</span></div><div class="announcement_content">å»¶è¿Ÿæ»¡è¶³</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS"><span class="toc-number">1.</span> <span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">1.2.</span> <span class="toc-text">ä¼˜åŠ¿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.</span> <span class="toc-text">åŒæ­¥çŠ¶æ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97"><span class="toc-number">1.4.</span> <span class="toc-text">åŒæ­¥é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%86%85%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">ä¸»è¦å†…ç½®æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS%EF%BC%9ACLH-%E5%90%8C%E6%AD%A5%E9%98%9F%E5%88%97"><span class="toc-number">2.</span> <span class="toc-text">AQSï¼šCLH åŒæ­¥é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">2.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Node"><span class="toc-number">2.2.</span> <span class="toc-text">Node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%88%97"><span class="toc-number">2.3.</span> <span class="toc-text">å…¥åˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BA%E5%88%97"><span class="toc-number">2.4.</span> <span class="toc-text">å‡ºåˆ—</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS%EF%BC%9A%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81%E7%9A%84%E8%8E%B7%E5%8F%96%E4%B8%8E%E9%87%8A%E6%94%BE"><span class="toc-number">3.</span> <span class="toc-text">AQSï¼šåŒæ­¥çŠ¶æ€çš„è·å–ä¸é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">ç‹¬å å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E5%BC%8F%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81%E8%8E%B7%E5%8F%96"><span class="toc-number">3.1.1.</span> <span class="toc-text">ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#acquireQueued"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">acquireQueued</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#shouldParkAfterFailedAcquire"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">shouldParkAfterFailedAcquire</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#cancelAcquire"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">cancelAcquire</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E5%BC%8F%E8%8E%B7%E5%8F%96%E5%93%8D%E5%BA%94%E4%B8%AD%E6%96%AD"><span class="toc-number">3.1.2.</span> <span class="toc-text">ç‹¬å å¼è·å–å“åº”ä¸­æ–­</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#doAcquireInterruptibly"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">doAcquireInterruptibly</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E5%BC%8F%E8%B6%85%E6%97%B6%E8%8E%B7%E5%8F%96"><span class="toc-number">3.1.3.</span> <span class="toc-text">ç‹¬å å¼è¶…æ—¶è·å–</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#tryAcquireNanos"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">tryAcquireNanos</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%8B%AC%E5%8D%A0%E5%BC%8F%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81%E9%87%8A%E6%94%BE"><span class="toc-number">3.1.4.</span> <span class="toc-text">ç‹¬å å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.1.5.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">å…±äº«å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%BC%8F%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81%E8%8E%B7%E5%8F%96"><span class="toc-number">3.2.1.</span> <span class="toc-text">å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#doAcquireShared"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">doAcquireShared</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#setHeadAndPropagate"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">setHeadAndPropagate</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%BC%8F%E8%8E%B7%E5%8F%96%E5%93%8D%E5%BA%94%E4%B8%AD%E6%96%AD"><span class="toc-number">3.2.2.</span> <span class="toc-text">å…±äº«å¼è·å–å“åº”ä¸­æ–­</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%BC%8F%E8%B6%85%E6%97%B6%E8%8E%B7%E5%8F%96"><span class="toc-number">3.2.3.</span> <span class="toc-text">å…±äº«å¼è¶…æ—¶è·å–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E5%BC%8F%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81%E9%87%8A%E6%94%BE"><span class="toc-number">3.2.4.</span> <span class="toc-text">å…±äº«å¼åŒæ­¥çŠ¶æ€é‡Šæ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#doReleaseShared"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">doReleaseShared</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS%EF%BC%9A%E9%98%BB%E5%A1%9E%E5%92%8C%E5%94%A4%E9%86%92%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">AQSï¼šé˜»å¡å’Œå”¤é†’çº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#parkAndCheckInterrupt"><span class="toc-number">4.1.</span> <span class="toc-text">parkAndCheckInterrupt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unparkSuccessor"><span class="toc-number">4.2.</span> <span class="toc-text">unparkSuccessor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LockSupport"><span class="toc-number">4.3.</span> <span class="toc-text">LockSupport</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#park"><span class="toc-number">4.4.</span> <span class="toc-text">park</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unpark"><span class="toc-number">4.5.</span> <span class="toc-text">unpark</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">4.6.</span> <span class="toc-text">å®ç°åŸç†</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/05/08/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E5%9B%9B%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬å››ç¯‡"><img src="https://zzc-sso.oss-cn-hangzhou.aliyuncs.com/bolg/wallhaven-pk8l5m.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ‰‹å†™mybatisç¬¬å››ç¯‡"/></a><div class="content"><a class="title" href="/2022/05/08/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E5%9B%9B%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬å››ç¯‡">æ‰‹å†™mybatisç¬¬å››ç¯‡</a><time datetime="2022-05-08T06:58:47.000Z" title="å‘è¡¨äº 2022-05-08 14:58:47">2022-05-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/11/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E4%B8%89%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬ä¸‰ç¯‡"><img src="https://zzc-sso.oss-cn-hangzhou.aliyuncs.com/bolg/wallhaven-73zz29.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ‰‹å†™mybatisç¬¬ä¸‰ç¯‡"/></a><div class="content"><a class="title" href="/2022/04/11/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E4%B8%89%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬ä¸‰ç¯‡">æ‰‹å†™mybatisç¬¬ä¸‰ç¯‡</a><time datetime="2022-04-11T03:39:41.000Z" title="å‘è¡¨äº 2022-04-11 11:39:41">2022-04-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/10/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E4%BA%8C%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬äºŒç¯‡"><img src="http://hankz.oss-cn-hangzhou.aliyuncs.com/wallhaven-72pj33.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ‰‹å†™mybatisç¬¬äºŒç¯‡"/></a><div class="content"><a class="title" href="/2022/04/10/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E4%BA%8C%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬äºŒç¯‡">æ‰‹å†™mybatisç¬¬äºŒç¯‡</a><time datetime="2022-04-10T08:23:17.000Z" title="å‘è¡¨äº 2022-04-10 16:23:17">2022-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/10/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM%E7%AC%AC%E4%B8%80%E7%AF%87/" title="JVMä¸Javaä½“ç³»ç»“æ„"><img src="https://zzc-sso.oss-cn-hangzhou.aliyuncs.com/bolg/JVM/src%3Dhttp___upload-images.jianshu.io_upload_images_15462057-05caf5645086f1cf.png%26refer%3Dhttp___upload-images.jianshu.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JVMä¸Javaä½“ç³»ç»“æ„"/></a><div class="content"><a class="title" href="/2022/04/10/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JVM%E7%AC%AC%E4%B8%80%E7%AF%87/" title="JVMä¸Javaä½“ç³»ç»“æ„">JVMä¸Javaä½“ç³»ç»“æ„</a><time datetime="2022-04-10T07:17:31.000Z" title="å‘è¡¨äº 2022-04-10 15:17:31">2022-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/10/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E4%B8%80%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬ä¸€ç¯‡"><img src="https://zzc-sso.oss-cn-hangzhou.aliyuncs.com/bolg/%E7%AA%97%E5%8F%B0%20%E6%97%A5%E8%90%BD%20%E5%A5%B3%E5%AD%A9%20%C3%A8%20%E4%B9%A6%E6%9C%AC%20alena%20aenami%204k%E5%A3%81%E7%BA%B8_%E5%BD%BC%E5%B2%B8%E5%9B%BE%E7%BD%91.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ‰‹å†™mybatisç¬¬ä¸€ç¯‡"/></a><div class="content"><a class="title" href="/2022/04/10/%E6%89%8B%E5%86%99mybatis%E7%AC%AC%E4%B8%80%E7%AF%87/" title="æ‰‹å†™mybatisç¬¬ä¸€ç¯‡">æ‰‹å†™mybatisç¬¬ä¸€ç¯‡</a><time datetime="2022-04-10T07:17:31.000Z" title="å‘è¡¨äº 2022-04-10 15:17:31">2022-04-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By ç« å¿—æˆ</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a  target="_blank" rel="noopener" href="http://hankz.cc/">ä¸€ä¸ªcvå¤§å¸ˆ</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç®€</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'rX8EGp1QDIbaOBer0HPXb4wr-gzGzoHsz',
      appKey: 'zYi2FKT3jfoRihSzwUQkzwd3',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.17.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[å›¾ç‰‡]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[é“¾æ¥]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[ä»£ç ]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'æ²¡æœ‰è¯„è®º'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://rX8EGp1Q.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'rX8EGp1QDIbaOBer0HPXb4wr-gzGzoHsz',
        "X-LC-Key": 'zYi2FKT3jfoRihSzwUQkzwd3',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "æ— æ³•è·å–è¯„è®ºï¼Œè¯·ç¡®è®¤ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><div class="aplayer no-destroy" data-id="84943176" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-autoplay="false" data-theme="#2980b9" data-loop="all" data-order="random" data-preload="auto" data-volume="0.4" data-mutex="true" data-listFolded="true" data-listmaxheight="340px" data-storagename="metingjs" muted></div><div class="aplayer no-destroy" data-id="https://music.163.com/playlist?id=84943176&userid=77272308" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-autoplay="true" data-theme="#2980b9" data-loop="all" data-order="random" data-preload="auto" data-volume="0.4" data-mutex="true" data-listFolded="true" data-listmaxheight="340px" data-storagename="metingjs" muted></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="true"></script><script>(function(d, w, c) {
    w.ChatraID = 'K3d9XytKCJ4u5JfPd';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>