<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>spring-cache+redis自定义cache | 去海边</title><meta name="keywords" content="spring"><meta name="author" content="章志成"><meta name="copyright" content="章志成"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="使用spring cache+Redis整合redis hash等数据结构Spring cache源码分析  Cache、CacheManager：Cache抽象了缓存的通用操作，如get、put，而CacheManager是Cache的集合，之所以需要多个Cache对象，是因为需要多种缓存失效时间、缓存条目上限等 CacheInterceptor、CacheAspectSupport、Abstr"><meta property="og:type" content="article"><meta property="og:title" content="spring-cache+redis自定义cache"><meta property="og:url" content="http://example.com/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/index.html"><meta property="og:site_name" content="去海边"><meta property="og:description" content="使用spring cache+Redis整合redis hash等数据结构Spring cache源码分析  Cache、CacheManager：Cache抽象了缓存的通用操作，如get、put，而CacheManager是Cache的集合，之所以需要多个Cache对象，是因为需要多种缓存失效时间、缓存条目上限等 CacheInterceptor、CacheAspectSupport、Abstr"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208132131962.png"><meta property="article:published_time" content="2022-08-13T13:29:30.000Z"><meta property="article:modified_time" content="2022-08-14T08:29:35.247Z"><meta property="article:author" content="章志成"><meta property="article:tag" content="spring"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208132131962.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-08-14 16:29:35"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0!==o){const a=new Date;o=864e5*o,t={value:t,expiry:a.getTime()+o};localStorage.setItem(e,JSON.stringify(t))}},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);const o=new Date;if(!(o.getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=a=>new Promise((t,e)=>{const o=document.createElement("script");o.src=a,o.async=!0,o.onerror=e,o.onload=o.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(o.onload=o.onreadystatechange=null,t())},document.head.appendChild(o)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/tx2.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">79</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-messageboard"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202205192232746.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">去海边</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-messageboard"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">spring-cache+redis自定义cache</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-13T13:29:30.000Z" title="发表于 2022-08-13 21:29:30">2022-08-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-14T08:29:35.247Z" title="更新于 2022-08-14 16:29:35">2022-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/spring/">spring</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="spring-cache+redis自定义cache"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="使用spring-cache-Redis整合redis-hash等数据结构"><a href="#使用spring-cache-Redis整合redis-hash等数据结构" class="headerlink" title="使用spring cache+Redis整合redis hash等数据结构"></a>使用spring cache+Redis整合redis hash等数据结构</h1><h3 id="Spring-cache源码分析"><a href="#Spring-cache源码分析" class="headerlink" title="Spring cache源码分析"></a>Spring cache源码分析</h3><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208141601318.png" alt="preview"></p><ul><li>Cache、CacheManager：Cache抽象了缓存的通用操作，如get、put，而CacheManager是Cache的集合，之所以需要多个Cache对象，是因为需要多种缓存失效时间、缓存条目上限等</li><li>CacheInterceptor、CacheAspectSupport、AbstractCacheInvoker：CacheInterceptor是一个AOP方法拦截器，在方法前后做额外的逻辑，也即查询缓存、写入缓存等，它继承了CacheAspectSupport（缓存操作的主体逻辑）、AbstractCacheInvoker（封装了对Cache的读写）</li><li>CacheOperation、AnnotationCacheOperationSource、SpringCacheAnnotationParser：CacheOperation定义了缓存操作的缓存名字、缓存key、缓存条件condition、CacheManager等，AnnotationCacheOperationSource是一个获取缓存注解对应CacheOperation的类，而SpringCacheAnnotationParser是真正解析注解的类，解析后会封装成CacheOperation集合供AnnotationCacheOperationSource查找</li></ul><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="1、解析注解"><a href="#1、解析注解" class="headerlink" title="1、解析注解"></a>1、解析注解</h4><p><strong>SpringCacheAnnotationParser：负责解析注解，返回CacheOperation集合</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">public class SpringCacheAnnotationParser implements CacheAnnotationParser, Serializable &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 解析类级别的缓存注解</span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;CacheOperation&gt; parseCacheAnnotations(Class&lt;?&gt; type) &#123;</span><br><span class="line">        DefaultCacheConfig defaultConfig &#x3D; getDefaultCacheConfig(type);</span><br><span class="line">        return parseCacheAnnotations(defaultConfig, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 解析方法级别的缓存注解</span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;CacheOperation&gt; parseCacheAnnotations(Method method) &#123;</span><br><span class="line">        DefaultCacheConfig defaultConfig &#x3D; getDefaultCacheConfig(method.getDeclaringClass());</span><br><span class="line">        return parseCacheAnnotations(defaultConfig, method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 解析缓存注解</span><br><span class="line">    private Collection&lt;CacheOperation&gt; parseCacheAnnotations(DefaultCacheConfig cachingConfig, AnnotatedElement ae) &#123;</span><br><span class="line">        Collection&lt;CacheOperation&gt; ops &#x3D; null;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 解析@Cacheable注解</span><br><span class="line">        Collection&lt;Cacheable&gt; cacheables &#x3D; AnnotatedElementUtils.getAllMergedAnnotations(ae, Cacheable.class);</span><br><span class="line">        if (!cacheables.isEmpty()) &#123;</span><br><span class="line">            ops &#x3D; lazyInit(ops);</span><br><span class="line">            for (Cacheable cacheable : cacheables) &#123;</span><br><span class="line">                ops.add(parseCacheableAnnotation(ae, cachingConfig, cacheable));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 解析@CacheEvict注解</span><br><span class="line">        Collection&lt;CacheEvict&gt; evicts &#x3D; AnnotatedElementUtils.getAllMergedAnnotations(ae, CacheEvict.class);</span><br><span class="line">        if (!evicts.isEmpty()) &#123;</span><br><span class="line">            ops &#x3D; lazyInit(ops);</span><br><span class="line">            for (CacheEvict evict : evicts) &#123;</span><br><span class="line">                ops.add(parseEvictAnnotation(ae, cachingConfig, evict));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 解析@CachePut注解</span><br><span class="line">        Collection&lt;CachePut&gt; puts &#x3D; AnnotatedElementUtils.getAllMergedAnnotations(ae, CachePut.class);</span><br><span class="line">        if (!puts.isEmpty()) &#123;</span><br><span class="line">            ops &#x3D; lazyInit(ops);</span><br><span class="line">            for (CachePut put : puts) &#123;</span><br><span class="line">                ops.add(parsePutAnnotation(ae, cachingConfig, put));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 解析@Caching注解</span><br><span class="line">        Collection&lt;Caching&gt; cachings &#x3D; AnnotatedElementUtils.getAllMergedAnnotations(ae, Caching.class);</span><br><span class="line">        if (!cachings.isEmpty()) &#123;</span><br><span class="line">            ops &#x3D; lazyInit(ops);</span><br><span class="line">            for (Caching caching : cachings) &#123;</span><br><span class="line">                Collection&lt;CacheOperation&gt; cachingOps &#x3D; parseCachingAnnotation(ae, cachingConfig, caching);</span><br><span class="line">                if (cachingOps !&#x3D; null) &#123;</span><br><span class="line">                    ops.addAll(cachingOps);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return ops;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>AnnotationCacheOperationSource：调用SpringCacheAnnotationParser获取注解对应CacheOperation</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class AnnotationCacheOperationSource extends AbstractFallbackCacheOperationSource implements Serializable &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 查找类级别的CacheOperation列表</span><br><span class="line">    @Override</span><br><span class="line">    protected Collection&lt;CacheOperation&gt; findCacheOperations(final Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        return determineCacheOperations(new CacheOperationProvider() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Collection&lt;CacheOperation&gt; getCacheOperations(CacheAnnotationParser parser) &#123;</span><br><span class="line">                return parser.parseCacheAnnotations(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 查找方法级别的CacheOperation列表</span><br><span class="line">    @Override</span><br><span class="line">    protected Collection&lt;CacheOperation&gt; findCacheOperations(final Method method) &#123;</span><br><span class="line">        return determineCacheOperations(new CacheOperationProvider() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Collection&lt;CacheOperation&gt; getCacheOperations(CacheAnnotationParser parser) &#123;</span><br><span class="line">                return parser.parseCacheAnnotations(method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AbstractFallbackCacheOperationSource：AnnotationCacheOperationSource的父类，实现了获取CacheOperation的通用逻辑</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractFallbackCacheOperationSource implements CacheOperationSource &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Cache of CacheOperations, keyed by method on a specific target class.</span><br><span class="line">     * &lt;p&gt;As this base class is not marked Serializable, the cache will be recreated</span><br><span class="line">     * after serialization - provided that the concrete subclass is Serializable.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private final Map&lt;Object, Collection&lt;CacheOperation&gt;&gt; attributeCache &#x3D;</span><br><span class="line">            new ConcurrentHashMap&lt;Object, Collection&lt;CacheOperation&gt;&gt;(1024);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 根据Method、Class反射信息，获取对应的CacheOperation列表</span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;CacheOperation&gt; getCacheOperations(Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">        if (method.getDeclaringClass() &#x3D;&#x3D; Object.class) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object cacheKey &#x3D; getCacheKey(method, targetClass);</span><br><span class="line">        Collection&lt;CacheOperation&gt; cached &#x3D; this.attributeCache.get(cacheKey);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 因解析反射信息较耗时，所以用map缓存，避免重复计算</span><br><span class="line">                &#x2F;&#x2F; 如在map里已记录，直接返回</span><br><span class="line">        if (cached !&#x3D; null) &#123;</span><br><span class="line">            return (cached !&#x3D; NULL_CACHING_ATTRIBUTE ? cached : null);</span><br><span class="line">        &#125;</span><br><span class="line">                &#x2F;&#x2F; 否则做一次计算，然后写入map</span><br><span class="line">        else &#123;</span><br><span class="line">            Collection&lt;CacheOperation&gt; cacheOps &#x3D; computeCacheOperations(method, targetClass);</span><br><span class="line">            if (cacheOps !&#x3D; null) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Adding cacheable method &#39;&quot; + method.getName() + &quot;&#39; with attribute: &quot; + cacheOps);</span><br><span class="line">                &#125;</span><br><span class="line">                this.attributeCache.put(cacheKey, cacheOps);</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                this.attributeCache.put(cacheKey, NULL_CACHING_ATTRIBUTE);</span><br><span class="line">            &#125;</span><br><span class="line">            return cacheOps;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 计算缓存操作列表，优先用target代理类的方法上的注解，如果不存在则其次用target代理类，再次用原始类的方法，最后用原始类</span><br><span class="line">    private Collection&lt;CacheOperation&gt; computeCacheOperations(Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">        &#x2F;&#x2F; Don&#39;t allow no-public methods as required.</span><br><span class="line">        if (allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; The method may be on an interface, but we need attributes from the target class.</span><br><span class="line">        &#x2F;&#x2F; If the target class is null, the method will be unchanged.</span><br><span class="line">        Method specificMethod &#x3D; ClassUtils.getMostSpecificMethod(method, targetClass);</span><br><span class="line">        &#x2F;&#x2F; If we are dealing with method with generic parameters, find the original method.</span><br><span class="line">        specificMethod &#x3D; BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 调用findCacheOperations（由子类AnnotationCacheOperationSource实现），最终通过SpringCacheAnnotationParser来解析</span><br><span class="line">        &#x2F;&#x2F; First try is the method in the target class.</span><br><span class="line">        Collection&lt;CacheOperation&gt; opDef &#x3D; findCacheOperations(specificMethod);</span><br><span class="line">        if (opDef !&#x3D; null) &#123;</span><br><span class="line">            return opDef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Second try is the caching operation on the target class.</span><br><span class="line">        opDef &#x3D; findCacheOperations(specificMethod.getDeclaringClass());</span><br><span class="line">        if (opDef !&#x3D; null &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">            return opDef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (specificMethod !&#x3D; method) &#123;</span><br><span class="line">            &#x2F;&#x2F; Fallback is to look at the original method.</span><br><span class="line">            opDef &#x3D; findCacheOperations(method);</span><br><span class="line">            if (opDef !&#x3D; null) &#123;</span><br><span class="line">                return opDef;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; Last fallback is the class of the original method.</span><br><span class="line">            opDef &#x3D; findCacheOperations(method.getDeclaringClass());</span><br><span class="line">            if (opDef !&#x3D; null &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">                return opDef;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="2、逻辑执行"><a href="#2、逻辑执行" class="headerlink" title="2、逻辑执行"></a>2、逻辑执行</h4><p>以@Cacheable背后的逻辑为例。预期是先查缓存，如果缓存命中了就直接使用缓存值，否则执行业务逻辑，并把结果写入缓存。</p><p>ProxyCachingConfiguration：是一个配置类，用于生成CacheInterceptor类和CacheOperationSource类的Spring bean</p><p>CacheInterceptor：是一个AOP方法拦截器，它通过CacheOperationSource获取第1步解析注解的CacheOperation结果（如缓存名字、缓存key、condition条件），本质上是拦截原始方法的执行，在之前、之后增加逻辑</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 核心类，缓存拦截器</span><br><span class="line">public class CacheInterceptor extends CacheAspectSupport implements MethodInterceptor, Serializable &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 拦截原始方法的执行，在之前、之后增加逻辑</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(final MethodInvocation invocation) throws Throwable &#123;</span><br><span class="line">        Method method &#x3D; invocation.getMethod();</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 封装原始方法的执行到一个回调接口，便于后续调用</span><br><span class="line">        CacheOperationInvoker aopAllianceInvoker &#x3D; new CacheOperationInvoker() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Object invoke() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                                        &#x2F;&#x2F; 原始方法的执行</span><br><span class="line">                    return invocation.proceed();</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Throwable ex) &#123;</span><br><span class="line">                    throw new ThrowableWrapper(ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">                        &#x2F;&#x2F; 调用父类CacheAspectSupport的方法</span><br><span class="line">            return execute(aopAllianceInvoker, invocation.getThis(), method, invocation.getArguments());</span><br><span class="line">        &#125;</span><br><span class="line">        catch (CacheOperationInvoker.ThrowableWrapper th) &#123;</span><br><span class="line">            throw th.getOriginal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CacheAspectSupport：缓存切面支持类，是CacheInterceptor的父类，封装了所有的缓存操作的主体逻辑</strong></p><p>主要流程如下：</p><ol><li>通过CacheOperationSource，获取所有的CacheOperation列表</li><li>如果有@CacheEvict注解、并且标记为在调用前执行，则做删除/清空缓存的操作</li><li>如果有@Cacheable注解，查询缓存</li><li>如果缓存未命中（查询结果为null），则新增到cachePutRequests，后续执行原始方法后会写入缓存</li><li>缓存命中时，使用缓存值作为结果；缓存未命中、或有@CachePut注解时，需要调用原始方法，使用原始方法的返回值作为结果</li><li>如果有@CachePut注解，则新增到cachePutRequests</li><li>如果缓存未命中，则把查询结果值写入缓存；如果有@CachePut注解，也把方法执行结果写入缓存</li><li>如果有@CacheEvict注解、并且标记为在调用后执行，则做删除/清空缓存的操作</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 核心类，缓存切面支持类，封装了所有的缓存操作的主体逻辑</span><br><span class="line">public abstract class CacheAspectSupport extends AbstractCacheInvoker</span><br><span class="line">        implements BeanFactoryAware, InitializingBean, SmartInitializingSingleton &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; CacheInterceptor调父类的该方法</span><br><span class="line">    protected Object execute(CacheOperationInvoker invoker, Object target, Method method, Object[] args) &#123;</span><br><span class="line">        &#x2F;&#x2F; Check whether aspect is enabled (to cope with cases where the AJ is pulled in automatically)</span><br><span class="line">        if (this.initialized) &#123;</span><br><span class="line">            Class&lt;?&gt; targetClass &#x3D; getTargetClass(target);</span><br><span class="line">                        &#x2F;&#x2F; 通过CacheOperationSource，获取所有的CacheOperation列表</span><br><span class="line">            Collection&lt;CacheOperation&gt; operations &#x3D; getCacheOperationSource().getCacheOperations(method, targetClass);</span><br><span class="line">            if (!CollectionUtils.isEmpty(operations)) &#123;</span><br><span class="line">                                &#x2F;&#x2F; 继续调一个private的execute方法执行</span><br><span class="line">                return execute(invoker, method, new CacheOperationContexts(operations, method, args, target, targetClass));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果spring bean未初始化完成，则直接调用原始方法。相当于原始方法没有缓存功能。</span><br><span class="line">        return invoker.invoke();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        private的execute方法</span><br><span class="line">    private Object execute(final CacheOperationInvoker invoker, Method method, CacheOperationContexts contexts) &#123;</span><br><span class="line">        &#x2F;&#x2F; Special handling of synchronized invocation</span><br><span class="line">        if (contexts.isSynchronized()) &#123;</span><br><span class="line">            CacheOperationContext context &#x3D; contexts.get(CacheableOperation.class).iterator().next();</span><br><span class="line">            if (isConditionPassing(context, CacheOperationExpressionEvaluator.NO_RESULT)) &#123;</span><br><span class="line">                Object key &#x3D; generateKey(context, CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line">                Cache cache &#x3D; context.getCaches().iterator().next();</span><br><span class="line">                try &#123;</span><br><span class="line">                    return wrapCacheValue(method, cache.get(key, new Callable&lt;Object&gt;() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public Object call() throws Exception &#123;</span><br><span class="line">                            return unwrapReturnValue(invokeOperation(invoker));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Cache.ValueRetrievalException ex) &#123;</span><br><span class="line">                    &#x2F;&#x2F; The invoker wraps any Throwable in a ThrowableWrapper instance so we</span><br><span class="line">                    &#x2F;&#x2F; can just make sure that one bubbles up the stack.</span><br><span class="line">                    throw (CacheOperationInvoker.ThrowableWrapper) ex.getCause();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                &#x2F;&#x2F; No caching required, only call the underlying method</span><br><span class="line">                return invokeOperation(invoker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果有@CacheEvict注解、并且标记为在调用前执行，则做删除&#x2F;清空缓存的操作</span><br><span class="line">        &#x2F;&#x2F; Process any early evictions</span><br><span class="line">        processCacheEvicts(contexts.get(CacheEvictOperation.class), true,</span><br><span class="line">                CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果有@Cacheable注解，查询缓存</span><br><span class="line">        &#x2F;&#x2F; Check if we have a cached item matching the conditions</span><br><span class="line">        Cache.ValueWrapper cacheHit &#x3D; findCachedItem(contexts.get(CacheableOperation.class));</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果缓存未命中（查询结果为null），则新增到cachePutRequests，后续执行原始方法后会写入缓存</span><br><span class="line">        &#x2F;&#x2F; Collect puts from any @Cacheable miss, if no cached item is found</span><br><span class="line">        List&lt;CachePutRequest&gt; cachePutRequests &#x3D; new LinkedList&lt;CachePutRequest&gt;();</span><br><span class="line">        if (cacheHit &#x3D;&#x3D; null) &#123;</span><br><span class="line">            collectPutRequests(contexts.get(CacheableOperation.class),</span><br><span class="line">                    CacheOperationExpressionEvaluator.NO_RESULT, cachePutRequests);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object cacheValue;</span><br><span class="line">        Object returnValue;</span><br><span class="line"></span><br><span class="line">        if (cacheHit !&#x3D; null &amp;&amp; cachePutRequests.isEmpty() &amp;&amp; !hasCachePut(contexts)) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 缓存命中的情况，使用缓存值作为结果</span><br><span class="line">            &#x2F;&#x2F; If there are no put requests, just use the cache hit</span><br><span class="line">            cacheValue &#x3D; cacheHit.get();</span><br><span class="line">            returnValue &#x3D; wrapCacheValue(method, cacheValue);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">                        &#x2F;&#x2F; 缓存未命中、或有@CachePut注解的情况，需要调用原始方法</span><br><span class="line">            &#x2F;&#x2F; Invoke the method if we don&#39;t have a cache hit</span><br><span class="line">                        &#x2F;&#x2F; 调用原始方法，得到结果值</span><br><span class="line">            returnValue &#x3D; invokeOperation(invoker);</span><br><span class="line">            cacheValue &#x3D; unwrapReturnValue(returnValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果有@CachePut注解，则新增到cachePutRequests</span><br><span class="line">        &#x2F;&#x2F; Collect any explicit @CachePuts</span><br><span class="line">        collectPutRequests(contexts.get(CachePutOperation.class), cacheValue, cachePutRequests);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果缓存未命中，则把查询结果值写入缓存；如果有@CachePut注解，也把方法执行结果写入缓存</span><br><span class="line">        &#x2F;&#x2F; Process any collected put requests, either from @CachePut or a @Cacheable miss</span><br><span class="line">        for (CachePutRequest cachePutRequest : cachePutRequests) &#123;</span><br><span class="line">            cachePutRequest.apply(cacheValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; 如果有@CacheEvict注解、并且标记为在调用后执行，则做删除&#x2F;清空缓存的操作</span><br><span class="line">        &#x2F;&#x2F; Process any late evictions</span><br><span class="line">        processCacheEvicts(contexts.get(CacheEvictOperation.class), false, cacheValue);</span><br><span class="line"></span><br><span class="line">        return returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Cache.ValueWrapper findCachedItem(Collection&lt;CacheOperationContext&gt; contexts) &#123;</span><br><span class="line">        Object result &#x3D; CacheOperationExpressionEvaluator.NO_RESULT;</span><br><span class="line">        for (CacheOperationContext context : contexts) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 如果满足condition条件，才查询缓存</span><br><span class="line">            if (isConditionPassing(context, result)) &#123;</span><br><span class="line">                                &#x2F;&#x2F; 生成缓存key，如果注解中指定了key，则按照Spring表达式解析，否则使用KeyGenerator类生成</span><br><span class="line">                Object key &#x3D; generateKey(context, result);</span><br><span class="line">                                &#x2F;&#x2F; 根据缓存key，查询缓存值</span><br><span class="line">                Cache.ValueWrapper cached &#x3D; findInCaches(context, key);</span><br><span class="line">                if (cached !&#x3D; null) &#123;</span><br><span class="line">                    return cached;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                        logger.trace(&quot;No cache entry for key &#39;&quot; + key + &quot;&#39; in cache(s) &quot; + context.getCacheNames());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Cache.ValueWrapper findInCaches(CacheOperationContext context, Object key) &#123;</span><br><span class="line">        for (Cache cache : context.getCaches()) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 调用父类AbstractCacheInvoker的doGet方法，查询缓存</span><br><span class="line">            Cache.ValueWrapper wrapper &#x3D; doGet(cache, key);</span><br><span class="line">            if (wrapper !&#x3D; null) &#123;</span><br><span class="line">                if (logger.isTraceEnabled()) &#123;</span><br><span class="line">                    logger.trace(&quot;Cache entry for key &#39;&quot; + key + &quot;&#39; found in cache &#39;&quot; + cache.getName() + &quot;&#39;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                return wrapper;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>核心逻辑######</strong></p><p><strong>AbstractCacheInvoker：CacheAspectSupport的父类，封装了最终查询Cache接口的逻辑</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractCacheInvoker &#123;</span><br><span class="line">        &#x2F;&#x2F; 最终查询缓存的方法</span><br><span class="line">    protected Cache.ValueWrapper doGet(Cache cache, Object key) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">                        &#x2F;&#x2F; 调用Spring Cache接口的查询方法</span><br><span class="line">            return cache.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (RuntimeException ex) &#123;</span><br><span class="line">            getErrorHandler().handleCacheGetError(ex, cache, key);</span><br><span class="line">            return null;  &#x2F;&#x2F; If the exception is handled, return a cache miss</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p><strong>在项目中，某些业务场景需要使用到redis hash 或其他数据接口，而原生的spring cache其实是没有支持的，只能手动通过RedisTemplate,或者Redisson去编程式使用，如果我们想通过spring cache注解@Cacheable缓存hash数据结构，可以去自定义实现。</strong></p><p>简单写了一个springboot starter：</p><p><a target="_blank" rel="noopener" href="https://gitee.com/gump12138/cache-spring-boot-starter.git">https://gitee.com/gump12138/cache-spring-boot-starter.git</a></p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208141612399.png" alt="image-20220814161238494"></p><h2 id="spring-chache-Redis整合"><a href="#spring-chache-Redis整合" class="headerlink" title="spring chache + Redis整合"></a><strong>spring chache + Redis整合</strong></h2><h3 id="自定义cache"><a href="#自定义cache" class="headerlink" title="自定义cache"></a>自定义cache</h3><p>实现参考org.springframework.data.redis.cache.RedisCache：</p><ul><li>继承AbstractValueAdaptingCache</li><li>重写spring顶层cache接口的几个方法：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected Object lookup(Object key)&#123;&#125;;</span><br><span class="line">public synchronized &lt;T&gt; T get(Object key, Callable&lt;T&gt; valueLoader)&#123;&#125;;</span><br><span class="line">public void put(Object key, Object value)&#123;&#125;;</span><br><span class="line">public void evict(Object key)&#123;&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>自定义序列化方式</li></ul><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @description: 自定义cache 用于缓存Redis hash数据</span><br><span class="line"> * @author: zhangzc</span><br><span class="line"> * @modified By: zhangzc</span><br><span class="line"> * @date: Created in 2022&#x2F;7&#x2F;13 11:07</span><br><span class="line"> * @version:v1.0</span><br><span class="line"> * @see RedisCache</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class RedisHashCache extends AbstractValueAdaptingCache &#123;</span><br><span class="line"></span><br><span class="line">    private static final byte[] BINARY_NULL_VALUE &#x3D; RedisSerializer.java().serialize(NullValue.INSTANCE);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 缓存name</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * 现在只有: constraints</span><br><span class="line">     * &lt;&#x2F;p&gt;</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private final String name;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * redis config</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private final RedisCacheConfiguration cacheConfig;</span><br><span class="line">    private final ConversionService conversionService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public RedisHashCache(String name, RedisCacheConfiguration redisCacheConfiguration) &#123;</span><br><span class="line">        super(true);</span><br><span class="line"></span><br><span class="line">        Assert.notNull(name, &quot;Name must not be null&quot;);</span><br><span class="line"></span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">        this.cacheConfig &#x3D; redisCacheConfiguration;</span><br><span class="line">        this.conversionService &#x3D; cacheConfig.getConversionService();</span><br><span class="line"></span><br><span class="line">        Assert.notNull(cacheConfig, &quot;CacheConfig must not be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * @param key the key whose associated value is to be returned</span><br><span class="line">     * @return Object</span><br><span class="line">     * @see AbstractValueAdaptingCache#get(Object)</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @SneakyThrows</span><br><span class="line">    @Override</span><br><span class="line">    protected Object lookup(Object key) &#123;</span><br><span class="line">        HashKey hashKey &#x3D; convertHashKey(key);</span><br><span class="line"></span><br><span class="line">        if (hashKey.getHKey() &#x3D;&#x3D; null) &#123;</span><br><span class="line">            Map&lt;String, String&gt; valueMap &#x3D; RedisUtils.hGetall(hashKey.getRKey());</span><br><span class="line">            if (valueMap.isEmpty()) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            Map&lt;Object, Object&gt; convertedCacheValueMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">            for (Entry&lt;String, String&gt; entry : valueMap.entrySet()) &#123;</span><br><span class="line">                &#x2F;&#x2F; todo key只限制为了Long 待修改</span><br><span class="line">                convertedCacheValueMap.put(Long.valueOf(entry.getKey()), deserializeCacheValue(entry.getValue().getBytes()));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return convertedCacheValueMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        Object value &#x3D; RedisUtils.hGet(hashKey.getRKey(), hashKey.getHKey());</span><br><span class="line">        if (value &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return deserializeCacheValue(((String) value).getBytes(CHAR_SET));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Serialize the value to cache.</span><br><span class="line">     *</span><br><span class="line">     * @param value must not be &#123;@literal null&#125;.</span><br><span class="line">     * @return never &#123;@literal null&#125;.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @SneakyThrows</span><br><span class="line">    protected byte[] serializeCacheValue(Object value) &#123;</span><br><span class="line"></span><br><span class="line">        if (isAllowNullValues() &amp;&amp; value instanceof NullValue) &#123;</span><br><span class="line">            return BINARY_NULL_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return ByteUtils.getBytes(cacheConfig.getValueSerializationPair().write(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getNativeCache() &#123;</span><br><span class="line">        throw new RuntimeException(&quot;暂时不支持&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public synchronized &lt;T&gt; T get(Object key, Callable&lt;T&gt; valueLoader) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;暂时不支持&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void put(Object key, Object value) &#123;</span><br><span class="line">        Object cacheValue &#x3D; preProcessCacheValue(value);</span><br><span class="line"></span><br><span class="line">        if (!isAllowNullValues() &amp;&amp; cacheValue &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(String.format(&quot;Cache &#39;%s&#39; does not allow &#39;null&#39; values. Avoid storing null via &#39;@Cacheable(unless&#x3D;\&quot;#result &#x3D;&#x3D; null\&quot;)&#39; &quot;</span><br><span class="line">                + &quot;or configure RedisHashCache to allow &#39;null&#39; via RedisHashCacheConfiguration.&quot;, name));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (cacheValue instanceof Map) &#123;</span><br><span class="line"></span><br><span class="line">            Map valueMap &#x3D; (Map) value;</span><br><span class="line"></span><br><span class="line">            Map&lt;String, String&gt; targetMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">            valueMap.forEach((k, v) -&gt; targetMap.put(covertKeyToString(k), covertAndSerializeValueToString(v)));</span><br><span class="line"></span><br><span class="line">            RedisUtils.hPutAll(name + Constant.DOUBLE_COLON + convertKey(key), targetMap, cacheConfig.getTtl());</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            HashKey hashKey &#x3D; convertHashKey(key);</span><br><span class="line">            RedisUtils.hPut(hashKey.getRKey(), hashKey.getHKey(), covertAndSerializeValueToString(cacheValue), cacheConfig.getTtl());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String covertKeyToString(Object cacheRedisKey) &#123;</span><br><span class="line">        String hKey;</span><br><span class="line">        try &#123;</span><br><span class="line">            hKey &#x3D; String.valueOf(cacheRedisKey);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return hKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String covertAndSerializeValueToString(Object cacheValue) &#123;</span><br><span class="line">        String hValue;</span><br><span class="line">        try &#123;</span><br><span class="line">            hValue &#x3D; new String(serializeCacheValue(cacheValue), CHAR_SET);</span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        return hValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Convert &#123;@code key&#125; to a &#123;@link String&#125; representation used for cache key creation.</span><br><span class="line">     *</span><br><span class="line">     * @param key will never be &#123;@literal null&#125;.</span><br><span class="line">     * @return never &#123;@literal null&#125;.</span><br><span class="line">     * @throws IllegalStateException if &#123;@code key&#125; cannot be converted to &#123;@link String&#125;.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected String convertKey(Object key) &#123;</span><br><span class="line"></span><br><span class="line">        if (key instanceof String) &#123;</span><br><span class="line">            return (String) key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TypeDescriptor source &#x3D; TypeDescriptor.forObject(key);</span><br><span class="line"></span><br><span class="line">        if (conversionService.canConvert(source, TypeDescriptor.valueOf(String.class))) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                return conversionService.convert(key, String.class);</span><br><span class="line">            &#125; catch (ConversionFailedException e) &#123;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; may fail if the given key is a collection</span><br><span class="line">                if (isCollectionLikeOrMap(source)) &#123;</span><br><span class="line">                    return convertCollectionLikeOrMapKey(key, source);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method toString &#x3D; ReflectionUtils.findMethod(key.getClass(), &quot;toString&quot;);</span><br><span class="line"></span><br><span class="line">        if (toString !&#x3D; null &amp;&amp; !Object.class.equals(toString.getDeclaringClass())) &#123;</span><br><span class="line">            return key.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        throw new IllegalStateException(String.format(</span><br><span class="line">            &quot;Cannot convert cache key %s to String. Please register a suitable Converter via &#39;RedisCacheConfiguration.configureKeyConverters(...)&#39; or override &#39;%s.toString()&#39;.&quot;,</span><br><span class="line">            source, key.getClass().getSimpleName()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String convertCollectionLikeOrMapKey(Object key, TypeDescriptor source) &#123;</span><br><span class="line"></span><br><span class="line">        if (source.isMap()) &#123;</span><br><span class="line"></span><br><span class="line">            StringBuilder target &#x3D; new StringBuilder(&quot;&#123;&quot;);</span><br><span class="line"></span><br><span class="line">            for (Entry&lt;?, ?&gt; entry : ((Map&lt;?, ?&gt;) key).entrySet()) &#123;</span><br><span class="line">                target.append(convertKey(entry.getKey())).append(&quot;&#x3D;&quot;).append(convertKey(entry.getValue()));</span><br><span class="line">            &#125;</span><br><span class="line">            target.append(&quot;&#125;&quot;);</span><br><span class="line"></span><br><span class="line">            return target.toString();</span><br><span class="line">        &#125; else if (source.isCollection() || source.isArray()) &#123;</span><br><span class="line"></span><br><span class="line">            StringJoiner sj &#x3D; new StringJoiner(&quot;,&quot;);</span><br><span class="line"></span><br><span class="line">            Collection&lt;?&gt; collection &#x3D; source.isCollection() ? (Collection&lt;?&gt;) key : Arrays.asList(ObjectUtils.toObjectArray(key));</span><br><span class="line"></span><br><span class="line">            for (Object val : collection) &#123;</span><br><span class="line">                sj.add(convertKey(val));</span><br><span class="line">            &#125;</span><br><span class="line">            return &quot;[&quot; + sj.toString() + &quot;]&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        throw new IllegalArgumentException(String.format(&quot;Cannot convert cache key %s to String.&quot;, key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isCollectionLikeOrMap(TypeDescriptor source) &#123;</span><br><span class="line">        return source.isArray() || source.isCollection() || source.isMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String prefixCacheKey(String key) &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; allow contextual cache names by computing the key prefix on every call.</span><br><span class="line">        return cacheConfig.getKeyPrefixFor(name) + key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Customization hook called before passing object to</span><br><span class="line">     * &#123;@link org.springframework.data.redis.serializer.RedisSerializer&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @param value can be &#123;@literal null&#125;.</span><br><span class="line">     * @return preprocessed value. Can be &#123;@literal null&#125;.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Nullable</span><br><span class="line">    protected Object preProcessCacheValue(@Nullable Object value) &#123;</span><br><span class="line"></span><br><span class="line">        if (value !&#x3D; null) &#123;</span><br><span class="line">            return value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isAllowNullValues() ? NullValue.INSTANCE : null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ValueWrapper putIfAbsent(Object key, Object value) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;暂时不实现&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void evict(Object key) &#123;</span><br><span class="line">        HashKey hashKey &#x3D; convertHashKey(key);</span><br><span class="line"></span><br><span class="line">        RedisUtils.hDel(hashKey.getRKey(), hashKey.getHKey());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 暂定义 key&#x3D; RedisKey:HashKey</span><br><span class="line">     *</span><br><span class="line">     * @param key key</span><br><span class="line">     * @return HashKey</span><br><span class="line">     *&#x2F;</span><br><span class="line">    protected HashKey convertHashKey(Object key) &#123;</span><br><span class="line">        if (!(key instanceof String)) &#123;</span><br><span class="line">            throw new IllegalStateException(String.format(&quot;Cannot convert %s to String. Register a Converter or override toString().&quot;, key));</span><br><span class="line">        &#125;</span><br><span class="line">        String[] keyArray &#x3D; Optional.of((String) key).map(k -&gt; k.split(Constant.COLON)).orElse(new String[0]);</span><br><span class="line"></span><br><span class="line">        if (keyArray.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            return new HashKey(name + Constant.DOUBLE_COLON + keyArray[0]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (keyArray.length &lt; 2) &#123;</span><br><span class="line">            throw new IllegalStateException(String.format(&quot;Cannot convert %s to String. Register a Converter or override toString().&quot;, key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return new HashKey(name + Constant.DOUBLE_COLON + keyArray[0], keyArray[1]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void clear() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Getter</span><br><span class="line">    @AllArgsConstructor</span><br><span class="line">    public static class HashKey &#123;</span><br><span class="line"></span><br><span class="line">        private String RKey;</span><br><span class="line">        private String HKey;</span><br><span class="line"></span><br><span class="line">        public HashKey(String RKey) &#123;</span><br><span class="line">            this.RKey &#x3D; RKey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Deserialize the given value to the actual cache value.</span><br><span class="line">     *</span><br><span class="line">     * @param value must not be &#123;@literal null&#125;.</span><br><span class="line">     * @return can be &#123;@literal null&#125;.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Nullable</span><br><span class="line">    protected Object deserializeCacheValue(byte[] value) &#123;</span><br><span class="line"></span><br><span class="line">        if (isAllowNullValues() &amp;&amp; ObjectUtils.nullSafeEquals(value, BINARY_NULL_VALUE)) &#123;</span><br><span class="line">            return NullValue.INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return cacheConfig.getValueSerializationPair().read(ByteBuffer.wrap(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="自定义cacheManager"><a href="#自定义cacheManager" class="headerlink" title="自定义cacheManager"></a>自定义cacheManager</h3><p><strong>主要是为了管理我们指定的cache(支持缓存hash等)</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private Collection&lt;? extends RedisHashCache&gt; caches;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @description: 用于Redis存取hash cache</span><br><span class="line"> * @author: zhangzc</span><br><span class="line"> * @modified By: zhangzc</span><br><span class="line"> * @date: Created in 2022&#x2F;7&#x2F;13 11:52</span><br><span class="line"> * @version:v1.0</span><br><span class="line"> * @see RedisCacheManager</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class RedisHashCacheManager extends AbstractCacheManager &#123;</span><br><span class="line"></span><br><span class="line">    public static final String BEAN_NAME &#x3D; &quot;redisHashCacheManager&quot;;</span><br><span class="line"></span><br><span class="line">    private Collection&lt;? extends RedisHashCache&gt; caches;</span><br><span class="line"></span><br><span class="line">    public void setCaches(Collection&lt;? extends RedisHashCache&gt; caches) &#123;</span><br><span class="line">        this.caches &#x3D; caches;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Collection&lt;? extends RedisHashCache&gt; getCaches() &#123;</span><br><span class="line">        return caches;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Collection&lt;? extends Cache&gt; loadCaches() &#123;</span><br><span class="line">        return this.caches;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Bean(RedisHashCacheManager.BEAN_NAME)  </span><br><span class="line">#指定我们自定义的缓存管理器 在使用的时候需要指定</span><br><span class="line">#</span><br><span class="line">    @Override</span><br><span class="line">    @Cacheable(cacheManager &#x3D; RedisHashCacheManager.BEAN_NAME, value &#x3D; CacheConstant.CONSTRAINTS_TEMPLATE_PREFIX,</span><br><span class="line">        key &#x3D; CacheConstant.CONSTRAINTS_TEMPLATE_ID_KEY, unless &#x3D; &quot;#result eq null || #result.size() &lt; 1 &quot;)</span><br><span class="line">    public Map&lt;Long, List&lt;DataTypeConstraintValueBO&gt;&gt; getConstraintsMapByTemplateOnlyCached(Long templateId) &#123;</span><br><span class="line">    ...</span><br><span class="line">        return Collections.emptyMap();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">package cache.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import cache.domain.Constant;</span><br><span class="line">import cache.rediscache.RedisHashCache;</span><br><span class="line">import cache.rediscache.RedisHashCacheManager;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonInclude;</span><br><span class="line">import com.fasterxml.jackson.annotation.JsonTypeInfo;</span><br><span class="line">import com.fasterxml.jackson.databind.DeserializationFeature;</span><br><span class="line">import com.fasterxml.jackson.databind.MapperFeature;</span><br><span class="line">import com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line">import com.fasterxml.jackson.databind.SerializationFeature;</span><br><span class="line">import com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;</span><br><span class="line">import java.time.Duration;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.support.DefaultListableBeanFactory;</span><br><span class="line">import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;</span><br><span class="line">import org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line">import org.springframework.cache.CacheManager;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line">import org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line">import org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line">import org.springframework.data.redis.cache.RedisCacheWriter;</span><br><span class="line">import org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line">import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line">import org.springframework.data.redis.serializer.GenericToStringSerializer;</span><br><span class="line">import org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line">import org.springframework.http.converter.json.Jackson2ObjectMapperBuilder;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @description: 配置RedisHashCacheManage</span><br><span class="line"> * @author: zhangzc</span><br><span class="line"> * @modified By: zhangzc</span><br><span class="line"> * @date: Created in 2022&#x2F;7&#x2F;13 12:02</span><br><span class="line"> * @version:v1.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Configuration</span><br><span class="line">@ConditionalOnProperty(&quot;cache.enable&quot;)</span><br><span class="line">@EnableConfigurationProperties(RedisManagerProperties.class)</span><br><span class="line">public class RedisHashCacheConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisManagerProperties redisManagerProperties;</span><br><span class="line"></span><br><span class="line">    public RedisHashCacheConfiguration(DefaultListableBeanFactory factory) &#123;</span><br><span class="line">        factory.getBeanDefinition(RedisHashCacheManager.BEAN_NAME).setAutowireCandidate(false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 自定义hash cacheManage</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * 使用此manager</span><br><span class="line">     * &lt;&#x2F;p&gt;</span><br><span class="line">     *</span><br><span class="line">     * @return CacheManager</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean(RedisHashCacheManager.BEAN_NAME)</span><br><span class="line">    public CacheManager redisHashCacheManager(GenericToStringSerializer&lt;String&gt; genericToStringSerializer,</span><br><span class="line">                                              GenericJackson2JsonRedisSerializer genericJsonRedisSerializer) &#123;</span><br><span class="line"></span><br><span class="line">        RedisHashCacheManager cacheManager &#x3D; new RedisHashCacheManager();</span><br><span class="line">        List&lt;RedisHashCache&gt; caches &#x3D; new ArrayList&lt;&gt;(1);</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration redisCacheConfiguration &#x3D; RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">            .entryTtl(Duration.ofSeconds(redisManagerProperties.getTtlDuration()))</span><br><span class="line">            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(genericToStringSerializer))</span><br><span class="line">            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(genericJsonRedisSerializer));</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * @see RedisCacheManager#getMissingCache(String)</span><br><span class="line">         *&#x2F;</span><br><span class="line">        &#x2F;&#x2F; 手动添加缓存名 如果要使用这个cacheManger 每次加一个cacheName都需要在这里加上  todo 可以优化</span><br><span class="line">        caches.add(new RedisHashCache(Constant.CONSTRAINTS_TEMPLATE_PREFIX, redisCacheConfiguration));</span><br><span class="line">        cacheManager.setCaches(caches);</span><br><span class="line"></span><br><span class="line">        return cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 指定 @Cacheable默认的manager</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    public CacheManager cacheManager(RedisConnectionFactory redisConnectionFactory, GenericToStringSerializer&lt;String&gt; genericToStringSerializer,</span><br><span class="line">                                     GenericJackson2JsonRedisSerializer genericJsonRedisSerializer) &#123;</span><br><span class="line"></span><br><span class="line">        RedisCacheWriter redisCacheWriter &#x3D; RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration redisCacheConfiguration &#x3D; RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">            .entryTtl(Duration.ofSeconds(redisManagerProperties.getTtlDuration()))</span><br><span class="line">            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(genericToStringSerializer))</span><br><span class="line">            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(genericJsonRedisSerializer));</span><br><span class="line"></span><br><span class="line">        return new RedisCacheManager(redisCacheWriter, redisCacheConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public GenericToStringSerializer&lt;String&gt; genericToStringSerializer() &#123;</span><br><span class="line">        return new GenericToStringSerializer&lt;&gt;(String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public GenericJackson2JsonRedisSerializer genericJsonRedisSerializer() &#123;</span><br><span class="line">        ObjectMapper redisJsonMapper &#x3D; Jackson2ObjectMapperBuilder.json().serializationInclusion(JsonInclude.Include.NON_NULL)</span><br><span class="line">            .failOnUnknownProperties(false).featuresToDisable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS).build();</span><br><span class="line">        &#x2F;&#x2F; 把类名作为属性进行存储</span><br><span class="line">        redisJsonMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);</span><br><span class="line">        &#x2F;&#x2F; 剔除类上的所有注解</span><br><span class="line">        redisJsonMapper.configure(MapperFeature.USE_ANNOTATIONS, false);</span><br><span class="line">        redisJsonMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span><br><span class="line">        &#x2F;&#x2F; 枚举类使用toString方法进行反序列化</span><br><span class="line">        redisJsonMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, true);</span><br><span class="line">        &#x2F;&#x2F; 枚举类使用toString方法进行反序列化</span><br><span class="line">        redisJsonMapper.configure(SerializationFeature.WRITE_ENUMS_USING_TO_STRING, true);</span><br><span class="line">        return new GenericJackson2JsonRedisSerializer(redisJsonMapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@ConfigurationProperties(prefix &#x3D; &quot;cache-hash&quot;)</span><br><span class="line">public class RedisManagerProperties &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 实体缓存有效期，单位 秒，默认7200秒，即2小时</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private int ttlDuration &#x3D; 7200;</span><br><span class="line"></span><br><span class="line">    public int getTtlDuration() &#123;</span><br><span class="line">        return ttlDuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTtlDuration(int ttlDuration) &#123;</span><br><span class="line">        this.ttlDuration &#x3D; ttlDuration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Redis工具类"><a href="#Redis工具类" class="headerlink" title="Redis工具类"></a>Redis工具类</h3><p><strong>整合RedisTemplate、Redisson</strong></p><p><strong>Redisson可以保证设置缓存同时设置失效时间的原子性</strong> 基于lua脚本打包命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line">package cache.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import static cache.domain.Constant.CHAR_SET;</span><br><span class="line"></span><br><span class="line">import cache.helper.SpringContextHelper;</span><br><span class="line">import java.time.Duration;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.redisson.Redisson;</span><br><span class="line">import org.redisson.api.RMap;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.redisson.client.codec.StringCodec;</span><br><span class="line">import org.springframework.data.redis.core.RedisCallback;</span><br><span class="line">import org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line">import org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @description: Redis Utils</span><br><span class="line"> * @author: zhangzc</span><br><span class="line"> * @modified By: zhangzc</span><br><span class="line"> * @date: Created in 2022&#x2F;7&#x2F;8 11:50</span><br><span class="line"> * @version:v1.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Slf4j</span><br><span class="line">public class RedisUtils &#123;</span><br><span class="line"></span><br><span class="line">    public RedisUtils() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static final StringRedisTemplate redisTemplate &#x3D; SpringContextHelper</span><br><span class="line">        .getBean(&quot;stringRedisTemplate&quot;, StringRedisTemplate.class);</span><br><span class="line"></span><br><span class="line">    private static final RedissonClient redissonClient &#x3D; SpringContextHelper</span><br><span class="line">        .getBean(&quot;redisson&quot;, Redisson.class);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 设置有效时间</span><br><span class="line">     *</span><br><span class="line">     * @param key     Redis键</span><br><span class="line">     * @param timeout 超时时间</span><br><span class="line">     * @return true&#x3D;设置成功；false&#x3D;设置失败</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean expire(final String key, final long timeout) &#123;</span><br><span class="line">        return expire(key, timeout, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 设置有效时间</span><br><span class="line">     *</span><br><span class="line">     * @param key     Redis键</span><br><span class="line">     * @param timeout 超时时间</span><br><span class="line">     * @param unit    时间单位</span><br><span class="line">     * @return true&#x3D;设置成功；false&#x3D;设置失败</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean expire(final String key, final long timeout, final TimeUnit unit) &#123;</span><br><span class="line">        Boolean ret &#x3D; redisTemplate.expire(key, timeout, unit);</span><br><span class="line">        return ret !&#x3D; null &amp;&amp; ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 删除单个key</span><br><span class="line">     *</span><br><span class="line">     * @param key 键</span><br><span class="line">     * @return true&#x3D;删除成功；false&#x3D;删除失败</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static boolean del(final String key) &#123;</span><br><span class="line">        Boolean ret &#x3D; redisTemplate.delete(key);</span><br><span class="line">        return ret !&#x3D; null &amp;&amp; ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 删除多个key</span><br><span class="line">     *</span><br><span class="line">     * @param keys 键集合</span><br><span class="line">     * @return 成功删除的个数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static long del(final Collection&lt;String&gt; keys) &#123;</span><br><span class="line">        Long ret &#x3D; redisTemplate.delete(keys);</span><br><span class="line">        return ret &#x3D;&#x3D; null ? 0 : ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 存入普通对象</span><br><span class="line">     *</span><br><span class="line">     * @param key   Redis键</span><br><span class="line">     * @param value 值</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void set(final String key, final String value) &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value, 1, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 存入普通对象</span><br><span class="line">     *</span><br><span class="line">     * @param key     键</span><br><span class="line">     * @param value   值</span><br><span class="line">     * @param timeout 有效期，单位秒</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void set(final String key, final String value, final long timeout) &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key, value, timeout, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取普通对象</span><br><span class="line">     *</span><br><span class="line">     * @param key 键</span><br><span class="line">     * @return 对象</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static Object get(final String key) &#123;</span><br><span class="line">        return redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; -------------- hash操作start ------------</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往Hash中存入数据</span><br><span class="line">     *</span><br><span class="line">     * @param key   Redis键</span><br><span class="line">     * @param hKey  Hash键</span><br><span class="line">     * @param value 值</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void hPut(final String key, final String hKey, final Object value) &#123;</span><br><span class="line">        redisTemplate.opsForHash().put(key, hKey, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往Hash中存入数据 并设置过期时间</span><br><span class="line">     *</span><br><span class="line">     * @param key      Redis键</span><br><span class="line">     * @param hKey     Hash键</span><br><span class="line">     * @param value    值</span><br><span class="line">     * @param duration ttl</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void hPut(final String key, final String hKey, final String value, Duration duration) &#123;</span><br><span class="line">        RMap&lt;String, String&gt; map &#x3D; redissonClient.getMap(key, new StringCodec(CHAR_SET));</span><br><span class="line">        map.put(hKey, value);</span><br><span class="line">        map.expire(duration.getSeconds(), TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往hash存入整个hash</span><br><span class="line">     *</span><br><span class="line">     * @param key      RedisKey</span><br><span class="line">     * @param values   valueMap</span><br><span class="line">     * @param duration ttl</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void hPutAll(final String key, final Map&lt;String, String&gt; values, Duration duration) &#123;</span><br><span class="line">        RMap&lt;String, String&gt; map &#x3D; redissonClient.getMap(key, new StringCodec(CHAR_SET));</span><br><span class="line">        map.putAll(values);</span><br><span class="line">        map.expire(duration.getSeconds(), TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往Hash中存入多个数据</span><br><span class="line">     *</span><br><span class="line">     * @param key    Redis键</span><br><span class="line">     * @param values Hash键值对</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void hPutAll(final String key, final Map&lt;String, Object&gt; values) &#123;</span><br><span class="line">        redisTemplate.opsForHash().putAll(key, values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取Hash中的数据</span><br><span class="line">     *</span><br><span class="line">     * @param key  Redis键</span><br><span class="line">     * @param hKey Hash键</span><br><span class="line">     * @return Hash中的对象</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static Object hGet(final String key, final String hKey) &#123;</span><br><span class="line">        return redisTemplate.opsForHash().get(key, hKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取多个Hash中的数据</span><br><span class="line">     *</span><br><span class="line">     * @param key   Redis键</span><br><span class="line">     * @param hKeys Hash键集合</span><br><span class="line">     * @return Hash对象集合</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static List&lt;Object&gt; hMultiGet(final String key, final Collection&lt;Object&gt; hKeys) &#123;</span><br><span class="line">        return redisTemplate.opsForHash().multiGet(key, hKeys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取hash中所有的数据</span><br><span class="line">     *</span><br><span class="line">     * @param key Redis键</span><br><span class="line">     * @return HashMap</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static Map&lt;String, String&gt; hGetall(String key) &#123;</span><br><span class="line">        return redisTemplate.execute((RedisCallback&lt;Map&lt;String, String&gt;&gt;) con -&gt; &#123;</span><br><span class="line">            Map&lt;byte[], byte[]&gt; result &#x3D; con.hGetAll(key.getBytes());</span><br><span class="line">            if (CollectionUtils.isEmpty(result)) &#123;</span><br><span class="line">                return new HashMap&lt;&gt;(0);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Map&lt;String, String&gt; ans &#x3D; new HashMap&lt;&gt;(result.size());</span><br><span class="line">            for (Map.Entry&lt;byte[], byte[]&gt; entry : result.entrySet()) &#123;</span><br><span class="line">                ans.put(new String(entry.getKey()), new String(entry.getValue()));</span><br><span class="line">            &#125;</span><br><span class="line">            return ans;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 指定hash中hKey删除 可多key</span><br><span class="line">     *</span><br><span class="line">     * @param key  Redis键</span><br><span class="line">     * @param hKey Hash键</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void hDel(final String key, final String hKey) &#123;</span><br><span class="line">        if (hKey &#x3D;&#x3D; null) &#123;</span><br><span class="line">            del(key);</span><br><span class="line">            if (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.info(&quot;删除整个hash,RKey&#x3D;&#123;&#125;&quot;, key);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        redisTemplate.opsForHash().delete(key, hKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 指定RedisKey删除 整个hash</span><br><span class="line">     *</span><br><span class="line">     * @param key RedisKey</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void hDelAll(final String key) &#123;</span><br><span class="line">        redisTemplate.opsForHash().delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; -------------- hash操作end ------------</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;    public Map&lt;String, String&gt; hmget(String key, List&lt;String&gt; fields) &#123;</span><br><span class="line">&#x2F;&#x2F;        List&lt;String&gt; result &#x3D; redisTemplate.&lt;String, String&gt;opsForHash().multiGet(key, fields);</span><br><span class="line">&#x2F;&#x2F;        Map&lt;String, String&gt; ans &#x3D; new HashMap&lt;&gt;(fields.size());</span><br><span class="line">&#x2F;&#x2F;        int index &#x3D; -1;</span><br><span class="line">&#x2F;&#x2F;        for (String field : fields) &#123;</span><br><span class="line">&#x2F;&#x2F;            ++index;</span><br><span class="line">&#x2F;&#x2F;            if (result.get(index) &#x3D;&#x3D; null) &#123;</span><br><span class="line">&#x2F;&#x2F;                continue;</span><br><span class="line">&#x2F;&#x2F;            &#125;</span><br><span class="line">&#x2F;&#x2F;            ans.put(field, result.get(index));</span><br><span class="line">&#x2F;&#x2F;        &#125;</span><br><span class="line">&#x2F;&#x2F;        return ans;</span><br><span class="line">&#x2F;&#x2F;    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往Set中存入数据</span><br><span class="line">     *</span><br><span class="line">     * @param key    Redis键</span><br><span class="line">     * @param values 值</span><br><span class="line">     * @return 存入的个数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static long sSet(final String key, final String... values) &#123;</span><br><span class="line">        Long count &#x3D; redisTemplate.opsForSet().add(key, values);</span><br><span class="line">        return count &#x3D;&#x3D; null ? 0 : count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 删除Set中的数据</span><br><span class="line">     *</span><br><span class="line">     * @param key    Redis键</span><br><span class="line">     * @param values 值</span><br><span class="line">     * @return 移除的个数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static long sDel(final String key, final Object... values) &#123;</span><br><span class="line">        Long count &#x3D; redisTemplate.opsForSet().remove(key, values);</span><br><span class="line">        return count &#x3D;&#x3D; null ? 0 : count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往List中存入数据</span><br><span class="line">     *</span><br><span class="line">     * @param key   Redis键</span><br><span class="line">     * @param value 数据</span><br><span class="line">     * @return 存入的个数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static long lPush(final String key, final String value) &#123;</span><br><span class="line">        Long count &#x3D; redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">        return count &#x3D;&#x3D; null ? 0 : count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往List中存入多个数据</span><br><span class="line">     *</span><br><span class="line">     * @param key    Redis键</span><br><span class="line">     * @param values 多个数据</span><br><span class="line">     * @return 存入的个数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static long lPushAll(final String key, final Collection&lt;String&gt; values) &#123;</span><br><span class="line">        Long count &#x3D; redisTemplate.opsForList().rightPushAll(key, values);</span><br><span class="line">        return count &#x3D;&#x3D; null ? 0 : count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 往List中存入多个数据</span><br><span class="line">     *</span><br><span class="line">     * @param key    Redis键</span><br><span class="line">     * @param values 多个数据</span><br><span class="line">     * @return 存入的个数</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static long lPushAll(final String key, final String... values) &#123;</span><br><span class="line">        Long count &#x3D; redisTemplate.opsForList().rightPushAll(key, values);</span><br><span class="line">        return count &#x3D;&#x3D; null ? 0 : count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 从List中获取begin到end之间的元素</span><br><span class="line">     *</span><br><span class="line">     * @param key   Redis键</span><br><span class="line">     * @param start 开始位置</span><br><span class="line">     * @param end   结束位置（start&#x3D;0，end&#x3D;-1表示获取全部元素）</span><br><span class="line">     * @return List对象</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static List&lt;String&gt; lGet(final String key, final int start, final int end) &#123;</span><br><span class="line">        return redisTemplate.opsForList().range(key, start, end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author：zzc</span><br><span class="line"> * @date: 2022&#x2F;7&#x2F;27</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class Constant &#123;</span><br><span class="line"></span><br><span class="line">    public final static String CHAR_SET &#x3D; &quot;UTF-8&quot;;</span><br><span class="line"></span><br><span class="line">    public static final String DOUBLE_COLON &#x3D; &quot;::&quot;;</span><br><span class="line"></span><br><span class="line">    public static final String COLON &#x3D; &quot;:&quot;;</span><br><span class="line"></span><br><span class="line">    public static final String ASTERISK &#x3D; &quot;*&quot;;</span><br><span class="line"></span><br><span class="line">    public static final String CONSTRAINTS_TEMPLATE_PREFIX &#x3D; &quot;constraints::templateId&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="开启使用"><a href="#开启使用" class="headerlink" title="开启使用"></a>开启使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication(exclude &#x3D; RedissonAutoConfiguration.class)</span><br><span class="line">@EnableCaching</span><br><span class="line">public class CacheApplication &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(CacheApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring/">spring</a></div><div class="post_share"><div class="social-share" data-image="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208132131962.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/kele.png" target="_blank"><img class="post-qr-code-img" src="/img/kele.png" alt="觉得还不错，请他喝一瓶可乐"></a><div class="post-qr-code-desc">觉得还不错，请他喝一瓶可乐</div></li><li class="reward-item"><a href="/img/ali.jpg" target="_blank"><img class="post-qr-code-img" src="/img/ali.jpg" alt="雪碧也是可以的"></a><div class="post-qr-code-desc">雪碧也是可以的</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/20220718/spring-cache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><img class="next-cover" src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202206152330638.gif" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">spring-cache源码解析</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/tx2.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__name">章志成</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">79</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/gump12138"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cooper12138" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:994739211@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">延迟满足</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8spring-cache-Redis%E6%95%B4%E5%90%88redis-hash%E7%AD%89%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">使用spring cache+Redis整合redis hash等数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-cache%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.0.1.</span> <span class="toc-text">Spring cache源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.0.2.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E8%A7%A3%E6%9E%90%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">1、解析注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E9%80%BB%E8%BE%91%E6%89%A7%E8%A1%8C"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">2、逻辑执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-chache-Redis%E6%95%B4%E5%90%88"><span class="toc-number">1.1.</span> <span class="toc-text">spring chache + Redis整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89cache"><span class="toc-number">1.1.1.</span> <span class="toc-text">自定义cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89cacheManager"><span class="toc-number">1.1.2.</span> <span class="toc-text">自定义cacheManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.1.4.</span> <span class="toc-text">Redis工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.5.</span> <span class="toc-text">开启使用</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/" title="spring-cache+redis自定义cache"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208132131962.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="spring-cache+redis自定义cache"></a><div class="content"><a class="title" href="/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/" title="spring-cache+redis自定义cache">spring-cache+redis自定义cache</a><time datetime="2022-08-13T13:29:30.000Z" title="发表于 2022-08-13 21:29:30">2022-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220718/spring-cache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="spring-cache源码解析"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202206152330638.gif" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="spring-cache源码解析"></a><div class="content"><a class="title" href="/20220718/spring-cache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" title="spring-cache源码解析">spring-cache源码解析</a><time datetime="2022-07-18T12:10:14.000Z" title="发表于 2022-07-18 20:10:14">2022-07-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220710/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%9B%98/" title="如何搭建自己的网盘"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202207101923657.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="如何搭建自己的网盘"></a><div class="content"><a class="title" href="/20220710/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%9B%98/" title="如何搭建自己的网盘">如何搭建自己的网盘</a><time datetime="2022-07-10T11:22:08.000Z" title="发表于 2022-07-10 19:22:08">2022-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220615/SpringCloud-%E7%AC%AC1%E7%AB%A0-%E5%89%8D%E8%A8%80/" title="SpringCloud-第1章-前言"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202207052318052.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="SpringCloud-第1章-前言"></a><div class="content"><a class="title" href="/20220615/SpringCloud-%E7%AC%AC1%E7%AB%A0-%E5%89%8D%E8%A8%80/" title="SpringCloud-第1章-前言">SpringCloud-第1章-前言</a><time datetime="2022-06-15T15:35:48.000Z" title="发表于 2022-06-15 23:35:48">2022-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220612/%E6%89%8B%E5%86%99spring%E7%B3%BB%E5%88%97-%E7%AC%AC4%E7%AB%A0-AOP-1/" title="手写spring系列-第4章-AOP-1"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202206042241269.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="手写spring系列-第4章-AOP-1"></a><div class="content"><a class="title" href="/20220612/%E6%89%8B%E5%86%99spring%E7%B3%BB%E5%88%97-%E7%AC%AC4%E7%AB%A0-AOP-1/" title="手写spring系列-第4章-AOP-1">手写spring系列-第4章-AOP-1</a><time datetime="2022-06-11T16:28:06.000Z" title="发表于 2022-06-12 00:28:06">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 章志成</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://hankz.cc/">一个cv大师</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>function loadValine(){function e(){new Valine(Object.assign({el:"#vcomment",appId:"rX8EGp1QDIbaOBer0HPXb4wr-gzGzoHsz",appKey:"zYi2FKT3jfoRihSzwUQkzwd3",placeholder:"Please leave your footprints",avatar:"monsterid",meta:"nick,mail,link".split(","),pageSize:"10",lang:"zh-CN",recordIP:!1,serverURLs:"",emojiCDN:"",emojiMaps:"",enableQQ:!1,path:window.location.pathname,requiredFields:["nick,mail"],visitor:!1},null))}"function"==typeof Valine?e():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(e)}function loadOtherComment(){loadValine()}setTimeout(loadValine,0)</script></div><div class="aplayer no-destroy" data-id="84943176" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-autoplay="false" data-theme="#2980b9" data-loop="all" data-order="random" data-preload="auto" data-volume="0.4" data-mutex="true" data-listfolded="true" data-listmaxheight="340px" data-storagename="metingjs" muted></div><div class="aplayer no-destroy" data-id="https://music.163.com/playlist?id=84943176&userid=77272308" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-autoplay="true" data-theme="#2980b9" data-loop="all" data-order="random" data-preload="auto" data-volume="0.4" data-mutex="true" data-listfolded="true" data-listmaxheight="340px" data-storagename="metingjs" muted></div><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async mobile="true"></script><script>!function(t,a,n){a.ChatraID="K3d9XytKCJ4u5JfPd";var c=t.createElement("script");a[n]=a[n]||function(){(a[n].q=a[n].q||[]).push(arguments)},c.async=!0,c.src="https://call.chatra.io/chatra.js",t.head&&t.head.appendChild(c)}(document,window,"Chatra");var chatBtnFn=()=>{document.getElementById("chat_btn").addEventListener("click",function(){Chatra("openChat")})};function chatBtnHide(){Chatra("hide")}function chatBtnShow(){Chatra("show")}chatBtnFn()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script");var o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()}),document.addEventListener("pjax:send",function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>