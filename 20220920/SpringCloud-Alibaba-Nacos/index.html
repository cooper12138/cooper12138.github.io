<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringCloud-Alibaba-第一章 | 去海边</title><meta name="keywords" content="SpringCloud系列"><meta name="author" content="章志成"><meta name="copyright" content="章志成"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="NacosDynamic Naming and Configuration Service 一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台 使用官方文档： https:&#x2F;&#x2F;nacos.io&#x2F;zh-cn&#x2F;docs&#x2F;what-is-nacos.html 核心功能服务注册：Nacos Client 会通过发送 REST 请求的方式向 Nacos Server 注册自己的服务，提供自身的元"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud-Alibaba-第一章"><meta property="og:url" content="http://example.com/20220920/SpringCloud-Alibaba-Nacos/index.html"><meta property="og:site_name" content="去海边"><meta property="og:description" content="NacosDynamic Naming and Configuration Service 一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台 使用官方文档： https:&#x2F;&#x2F;nacos.io&#x2F;zh-cn&#x2F;docs&#x2F;what-is-nacos.html 核心功能服务注册：Nacos Client 会通过发送 REST 请求的方式向 Nacos Server 注册自己的服务，提供自身的元"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202213367.png"><meta property="article:published_time" content="2022-09-20T14:11:58.000Z"><meta property="article:modified_time" content="2022-09-20T16:36:51.680Z"><meta property="article:author" content="章志成"><meta property="article:tag" content="SpringCloud系列"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202213367.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/20220920/SpringCloud-Alibaba-Nacos/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"bottom-left"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-09-21 00:36:51"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0!==o){const a=new Date;o=864e5*o,t={value:t,expiry:a.getTime()+o};localStorage.setItem(e,JSON.stringify(t))}},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);const o=new Date;if(!(o.getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=a=>new Promise((t,e)=>{const o=document.createElement("script");o.src=a,o.async=!0,o.onerror=e,o.onload=o.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(o.onload=o.onreadystatechange=null,t())},document.head.appendChild(o)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/tx2.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">79</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-messageboard"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202213367.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">去海边</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-messageboard"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud-Alibaba-第一章</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-20T14:11:58.000Z" title="发表于 2022-09-20 22:11:58">2022-09-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-20T16:36:51.680Z" title="更新于 2022-09-21 00:36:51">2022-09-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringCloud%E7%B3%BB%E5%88%97/">SpringCloud系列</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="SpringCloud-Alibaba-第一章"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/20220920/SpringCloud-Alibaba-Nacos/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/20220920/SpringCloud-Alibaba-Nacos/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h1><p>Dynamic Naming and Configuration Service</p><p>一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>官方文档： <a href="https://xie.infoq.cn/link?target=https://nacos.io/zh-cn/docs/what-is-nacos.html">https://nacos.io/zh-cn/docs/what-is-nacos.html</a></p><h3 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h3><p><strong>服务注册</strong>：Nacos Client 会通过发送 REST 请求的方式向 Nacos Server 注册自己的服务，提供自身的元数据，比如 ip 地址、端口等信息。Nacos Server 接收到注册请求后，就会把这些元数据信息存储在一个双层的内存 Map 中。</p><p><strong>服务心跳</strong>：在服务注册后，Nacos Client 会维护一个定时心跳来持续通知 Nacos Server，说明服务一直处于可用状态，防止被剔除。默认 5s 发送一次心跳。</p><p><strong>服务同步</strong>：Nacos Server 集群之间会互相同步服务实例，用来保证服务信息的一致性。</p><p><strong>服务发现</strong>：服务消费者（Nacos Client）在调用服务提供者的服务时，会发送一个 REST 请求给 Nacos Server，获取上面注册的服务清单，并且缓存在 Nacos Client 本地，同时会在 Nacos Client 本地开启一个定时任务定时拉取服务端最新的注册表信息更新到本地缓存。</p><p><strong>服务健康检查</strong>：Nacos Server 会开启一个定时任务用来检查注册服务实例的健康情况，对于超过 15s 没有收到客户端心跳的实例会将它的 healthy 属性置为 false(客户端服务发现时不会发现)，如果某个实例超过 30 秒没有收到心跳，直接剔除该实例(被剔除的实例如果恢复发送心跳则会重新注册)。</p><h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><p>搭建 Nacos-client 服务</p><p>1）引入依赖</p><p>父 Pom 中支持 spring cloud&amp;spring cloud alibaba, 引入依赖。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--引入springcloud的版本--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;Greenwich.SR3&lt;/version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.1.1.RELEASE&lt;/version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;repositories&gt;</span><br><span class="line">    &lt;repository&gt;</span><br><span class="line">        &lt;id&gt;spring&lt;/id&gt;</span><br><span class="line">        &lt;url&gt;https:<span class="comment">//maven.aliyun.com/repository/spring&lt;/url&gt;</span></span><br><span class="line">        &lt;releases&gt;</span><br><span class="line">            &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">        &lt;/releases&gt;</span><br><span class="line">        &lt;snapshots&gt;</span><br><span class="line">            &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">        &lt;/snapshots&gt;</span><br><span class="line">    &lt;/repository&gt;</span><br><span class="line">&lt;/repositories&gt;</span><br></pre></td></tr></table></figure><p>当前项目 pom 中引入依赖</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>2）application.properties 中配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=8002</span></span><br><span class="line"><span class="comment">#微服务名称</span></span><br><span class="line"><span class="string">spring.application.name=service-user</span></span><br><span class="line"><span class="comment">#配置 Nacos server 的地址</span></span><br><span class="line"><span class="string">spring.cloud.nacos.discovery.server-addr=localhost:8848</span></span><br></pre></td></tr></table></figure><p>更多配置：<a href="https://xie.infoq.cn/link?target=https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery">https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery</a></p><p>3）启动 springboot 应用，nacos 管理端界面查看是否成功注册</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202240348.png" alt="img"></p><p><strong>服务注册表结构</strong></p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202241144.png" alt="img"></p><p><strong>数据模型</strong></p><p>Nacos 数据模型 Key 由三元组唯一确定, Namespace 默认是空串，公共命名空间（public），分组默认是 DEFAULT_GROUP。</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202241770.jpeg" alt="img"></p><p><strong>服务领域模型</strong></p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202242379.jpeg" alt="img"></p><p>官网地址：<a href="https://xie.infoq.cn/link?target=https://nacos.io/zh-cn/docs/architecture.html">https://nacos.io/zh-cn/docs/architecture.html</a></p><p><strong>服务实例数据</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">	<span class="attr">&quot;clusterName&quot;</span>: <span class="string">&quot;DEFAULT&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;ephemeral&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;healthy&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;instanceHeartBeatInterval&quot;</span>: <span class="number">5000</span>,</span><br><span class="line">	<span class="attr">&quot;instanceHeartBeatTimeOut&quot;</span>: <span class="number">15000</span>,</span><br><span class="line">	<span class="attr">&quot;instanceId&quot;</span>: <span class="string">&quot;127.0.0.1#8880#DEFAULT#DEFAULT_GROUP@@orderService&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;instanceIdGenerator&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;ipDeleteTimeout&quot;</span>: <span class="number">30000</span>,</span><br><span class="line">	<span class="attr">&quot;metadata&quot;</span>: &#123;&#125;,</span><br><span class="line">	<span class="attr">&quot;port&quot;</span>: <span class="number">8880</span>,</span><br><span class="line">	<span class="attr">&quot;serviceName&quot;</span>: <span class="string">&quot;DEFAULT_GROUP@@orderService&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;weight&quot;</span>: <span class="number">1.0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="attr">&quot;clusterName&quot;</span>: <span class="string">&quot;DEFAULT&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;ephemeral&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;healthy&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">&quot;instanceHeartBeatInterval&quot;</span>: <span class="number">5000</span>,</span><br><span class="line">	<span class="attr">&quot;instanceHeartBeatTimeOut&quot;</span>: <span class="number">15000</span>,</span><br><span class="line">	<span class="attr">&quot;instanceId&quot;</span>: <span class="string">&quot;127.0.0.1#8888#DEFAULT#DEFAULT_GROUP@@orderService&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;instanceIdGenerator&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;ipDeleteTimeout&quot;</span>: <span class="number">30000</span>,</span><br><span class="line">	<span class="attr">&quot;metadata&quot;</span>: &#123;&#125;,</span><br><span class="line">	<span class="attr">&quot;port&quot;</span>: <span class="number">8888</span>,</span><br><span class="line">	<span class="attr">&quot;serviceName&quot;</span>: <span class="string">&quot;DEFAULT_GROUP@@orderService&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;weight&quot;</span>: <span class="number">1.0</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202246625.png" alt="img"></p><p><strong>Nacos 基本架构</strong></p><p>Naming Service：用来做服务发现的模块</p><p>Config Service：用来提供配置项管理、动态更新配置和元数据的功能</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202331584.png" alt="image-20220920233149787"></p><p>Nacos Core 模块：提供一系列的平台基础功能，是支撑 Nacos 上层业务场景的基石</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202333942.png" alt="image-20220920233324003"></p><p>Nacos 还有一个“一致性协议”，用来确保 Nacos 集群中各个节点之间的数据一致性。Nacos 内部支持两种一致性协议，一种是侧重 一致性的 Raft 协议，基于集群中选举出来的 Leader 节点进行数据写入；另一种是针对临 时节点的 Distro 协议，它是一个侧重可用性（或最终一致性）的分布式一致性协议。</p><p><strong>Nacos 自动装配原理</strong></p><p>Nacos 是怎么在启动阶段自动加载配置项并开启相关功能的呢？</p><p>将 Nacos 依赖项添加到项目中，同时也引入了 Nacos 自带的自动装配器，比如下面 这几个被引入的自动装配器就掌管了 Nacos 核心功能的初始化任务。</p><p><strong>NacosDiscoveryAutoConfiguration：</strong>服务发现功能的自动装配器，它主要做两件事 儿：加载 Nacos 配置项，声明 NacosServiceDiscovery 类用作服务发现；</p><p><strong>NacosServiceAutoConfiguration：</strong>声明核心服务治理类 NacosServiceManager， 它可以通过 service id、group 等一系列参数获取已注册的服务列表；</p><p><strong>NacosServiceRegistryAutoConfiguration</strong>：Nacos 服务注册的自动装配器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:echooy.mxq@gmail.com&quot;&gt;echooymxq&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="comment">// 当spring.cloud.discovery.enabled=true时才生效</span></span><br><span class="line"><span class="meta">@ConditionalOnDiscoveryEnabled</span></span><br><span class="line"><span class="comment">//当spring.cloud.nacos.discovery.enabled=true时生效</span></span><br><span class="line"><span class="meta">@ConditionalOnNacosDiscoveryEnabled</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosDiscoveryAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取Nacos所有配置项并封装到NacosDiscoveryProperties中</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> NacosDiscoveryProperties <span class="title">nacosProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> NacosDiscoveryProperties();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明服务发现的功能类NacosServiceDiscovery</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> NacosServiceDiscovery <span class="title">nacosServiceDiscovery</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			NacosDiscoveryProperties discoveryProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">			NacosServiceManager nacosServiceManager)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> NacosServiceDiscovery(discoveryProperties, nacosServiceManager);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NacosDiscoveryProperties 类通过 ConfigurationProperties 注解从 spring.cloud.nacos.discovery 路径下获取配置项，Spring 框架会自动将这些配置项解析 到 NacosDiscoveryProperties 类定义的类属性中。这样一来 Nacos 就完成了配置项的加 载，在其它业务流程中，只需要注入 NacosDiscoveryProperties 类就可以读取 Nacos 的 配置参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义了配置项读取的路径</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;spring.cloud.nacos.discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosDiscoveryProperties</span> </span>&#123;</span><br><span class="line"><span class="comment">// 省略类属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosServiceDiscovery</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 封装了Nacos配置项的类</span></span><br><span class="line">	<span class="keyword">private</span> NacosDiscoveryProperties discoveryProperties;</span><br><span class="line">	<span class="comment">// 另一个自动装配器声明的核心服务治理类</span></span><br><span class="line">	<span class="keyword">private</span> NacosServiceManager nacosServiceManager;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 根据服务名称获取所有已注册服务</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;ServiceInstance&gt; <span class="title">getInstances</span><span class="params">(String serviceId)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">		String group = discoveryProperties.getGroup();</span><br><span class="line">		List&lt;Instance&gt; instances = namingService().selectInstances(serviceId, group,</span><br><span class="line">				<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">return</span> hostToServiceInstanceList(instances, serviceId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回所有服务的服务名称</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServices</span><span class="params">()</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">		String group = discoveryProperties.getGroup();</span><br><span class="line">		ListView&lt;String&gt; services = namingService().getServicesOfServer(<span class="number">1</span>,</span><br><span class="line">				Integer.MAX_VALUE, group);</span><br><span class="line">		<span class="keyword">return</span> services.getData();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 NacosServiceDiscovery 暴露的方法，我们就能够根据 serviceId（注册到 nacos 的 服务名称）查询到可用的服务实例，获取到服务实例列表之后，调用方就可以发起远程服 务调用了。</p><p><strong>Nacos 配置项</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cloud:</span><br><span class="line">    nacos:</span><br><span class="line">        discovery:</span><br><span class="line">            <span class="comment"># Nacos的服务注册地址，可以配置多个，逗号分隔</span></span><br><span class="line">            server-addr: localhost:8848</span><br><span class="line">            <span class="comment"># 服务注册到Nacos上的名称，一般不用配置</span></span><br><span class="line">            service: coupon-customer-serv</span><br><span class="line">            <span class="comment"># nacos客户端向服务端发送心跳的时间间隔，时间单位其实是ms</span></span><br><span class="line">            heart-beat-interval: 5000</span><br><span class="line">            <span class="comment"># 服务端没有接受到客户端心跳请求就将其设为不健康的时间间隔，默认为15s</span></span><br><span class="line">            <span class="comment"># 注：推荐值该值为15s即可，如果有的业务线希望服务下线或者出故障时希望尽快被发现，可</span></span><br><span class="line">            heart-beat-timeout: 20000</span><br><span class="line">            <span class="comment"># 元数据部分 - 可以自己随便定制</span></span><br><span class="line">            metadata:</span><br><span class="line">            mydata: abc</span><br><span class="line">            <span class="comment"># 客户端在启动时是否读取本地配置项(一个文件)来获取服务列表</span></span><br><span class="line">            <span class="comment"># 注：推荐该值为false，若改成true。则客户端会在本地的一个</span></span><br><span class="line">            <span class="comment"># 文件中保存服务信息，当下次宕机启动时，会优先读取本地的配置对外提供服务。</span></span><br><span class="line">            naming-load-cache-at-start: false</span><br><span class="line">            <span class="comment"># 命名空间ID，Nacos通过不同的命名空间来区分不同的环境，进行数据隔离，</span></span><br><span class="line">            namespace: dev</span><br><span class="line">            <span class="comment"># 创建不同的集群</span></span><br><span class="line">            cluster-name: Cluster-A</span><br><span class="line">            <span class="comment"># [注意]两个服务如果存在上下游调用关系，必须配置相同的group才能发起访问</span></span><br><span class="line">            group: myGroup</span><br><span class="line">            <span class="comment"># 向注册中心注册服务，默认为true</span></span><br><span class="line">            <span class="comment"># 如果只消费服务，不作为服务提供方，倒是可以设置成false，减少开销</span></span><br><span class="line">            register-enabled: true</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202350665.png" alt="image-20220920235023875"></p><p><strong>Nacos 服务发现底层实现</strong></p><p>Nacos Client 通过一种主动轮询的机制从 Nacos Server 获取服务注册信息，包括地址列 表、group 分组、cluster 名称等一系列数据。简单来说，Nacos Client 会开启一个本地 的定时任务，每间隔一段时间，就尝试从 Nacos Server 查询服务注册表，并将最新的注 册信息更新到本地。这种方式也被称之为“Pull”模式，即客户端主动从服务端拉取的模 式。 负责拉取服务的任务是 UpdateTask 类，它实现了 Runnable 接口。Nacos 以开启线程的 方式调用 UpdateTask 类中的 run 方法，触发本地的服务发现查询请求。</p><p>UpdateTask 这个类隐藏得非常深，它是 HostReactor的一个内部类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ...省略部分代码</span></span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> delayTime = DEFAULT_DELAY;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//根据service name获取到当前服务的信息，包括服务器地址列表</span></span><br><span class="line">                ServiceInfo serviceObj = serviceInfoMap.get(ServiceInfo.getKey(serviceName, clusters));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果为空，则重新拉取最新的服务列表</span></span><br><span class="line">                <span class="keyword">if</span> (serviceObj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    updateService(serviceName, clusters);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//如果时间戳&lt;=上次更新的时间，则进行更新操作</span></span><br><span class="line">                <span class="keyword">if</span> (serviceObj.getLastRefTime() &lt;= lastRefTime) &#123;</span><br><span class="line">                    updateService(serviceName, clusters);</span><br><span class="line">                    serviceObj = serviceInfoMap.get(ServiceInfo.getKey(serviceName, clusters));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果serviceObj的refTime更晚，</span></span><br><span class="line">					<span class="comment">// 则表示服务通过主动push机制已被更新，这时我们只进行刷新操作</span></span><br><span class="line">                    refreshOnly(serviceName, clusters);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//刷新服务的更新时间</span></span><br><span class="line">                lastRefTime = serviceObj.getLastRefTime();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果订阅被取消，则停止更新任务</span></span><br><span class="line">                <span class="keyword">if</span> (!eventDispatcher.isSubscribed(serviceName, clusters) &amp;&amp; !futureMap</span><br><span class="line">                        .containsKey(ServiceInfo.getKey(serviceName, clusters))) &#123;</span><br><span class="line">                    <span class="comment">// abort the update task</span></span><br><span class="line">                    NAMING_LOGGER.info(<span class="string">&quot;update task is stopped, service:&quot;</span> + serviceName + <span class="string">&quot;, clusters:&quot;</span> + clusters);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果没有可供调用的服务列表，则统计失败次数+1</span></span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isEmpty(serviceObj.getHosts())) &#123;</span><br><span class="line">                    incFailCount();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 设置延迟一段时间后进行查询</span></span><br><span class="line">                delayTime = serviceObj.getCacheMillis();</span><br><span class="line">                <span class="comment">// 将失败查询次数重置为0</span></span><br><span class="line">                resetFailCount();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                incFailCount();</span><br><span class="line">                NAMING_LOGGER.warn(<span class="string">&quot;[NA] failed to update serviceName: &quot;</span> + serviceName, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 设置下一次查询任务的触发时间</span></span><br><span class="line">                executor.schedule(<span class="keyword">this</span>, Math.min(delayTime &lt;&lt; failCount, DEFAULT_DELAY * <span class="number">60</span>), TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>客户端负载均衡</strong></p><p>Spring Cloud Loadbalancer 采用了客户端负载均衡技术，每个发起服务调用的客户端都 存有完整的目标服务地址列表，根据配置的负载均衡策略，由客户端自己决定向哪台服务 器发起调用。</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209210000321.png" alt="image-20220921000035451"></p><p>客户端负载均衡的优势很明显。</p><p>网络开销小：由客户端直接发起点对点的服务调用，没有中间商赚差价；</p><p>配置灵活：各个客户端可以根据自己的需要灵活定制负载均衡策略。</p><p><strong>客户端负载均衡技术往往需要依赖服务发现技术来获取服务列表</strong></p><p><strong>Loadbalancer 工作原理</strong></p><p>…todo 2022/09/21</p><h1 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h1><p>OpenFeign 组件的前身是 Netflix Feign 项目，它最早是作为 Netflix OSS 项目的一部 分，由 Netflix 公司开发。后来 Feign 项目被贡献给了开源组织，于是才有了我们今天使 用的 Spring Cloud OpenFeign 组件。</p><p>OpenFeign 提供了一种声明式的远程调用接口，它可以大幅简化远程调用的编程体验</p><p>OpenFeign 使用了一种“动态代理”技术来封装远程服务调用的过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;hello-world-serv&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloWorldService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/sayHello&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(String guestName)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>服务的名称、接口类型、访问路径已经通过注解做了声明</p><p>OpenFeign 通过解析这些注解标签生成一个“动态代理类”，这个代理类会将接口调用转 化为一个远程服务调用的 Request，并发送给目标服务。</p><h2 id="OpenFeign-的动态代理"><a href="#OpenFeign-的动态代理" class="headerlink" title="OpenFeign 的动态代理"></a>OpenFeign 的动态代理</h2><p>在项目初始化阶段，OpenFeign 会生成一个代理类，对所有通过该接口发起的远程调用进 行动态代理。</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209210011297.png" alt="image-20220921001114427"></p><p>上图中的步骤 1 到步骤 3 是在项目启动阶段加载完成的，只有第 4 步“调用远程服务”是 发生在项目的运行阶段。</p><p>首先，在项目启动阶段，<strong>OpenFeign 框架会发起一个主动的扫包流程</strong>，从指定的目录下扫 描并加载所有被 @FeignClient 注解修饰的接口。</p><p>然后，<strong>OpenFeign 会针对每一个 FeignClient 接口生成一个动态代理对象</strong>，即图中的 FeignProxyService，这个代理对象在继承关系上属于 FeignClient 注解所修饰的接口的实 例。</p><p>接下来，<strong>这个动态代理对象会被添加到 Spring 上下文中，并注入到对应的服务里</strong>，也就 是图中的 LocalService 服务。</p><p>最后，<strong>LocalService 会发起底层方法调用</strong>。实际上这个方法调用会被 OpenFeign 生成的代理对象接管，由代理对象发起一个远程服务调用，并将调用的结果返回给 LocalService。</p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209210012483.png" alt="image-20220921001251664"></p><pre><code>                                                                 **OpenFeign 组件加载过程**
</code></pre><p><strong>OpenFeign 动态代理类的创建过程</strong></p><ol><li>项目加载：在项目的启动阶段，EnableFeignClients 注解扮演了“启动开关”的角 色，它使用 Spring 框架的 <strong>Import 注解</strong>导入了 FeignClientsRegistrar 类，开始了 OpenFeign 组件的加载过程。</li><li>扫包：<strong>FeignClientsRegistrar</strong> 负责 FeignClient 接口的加载，它会在指定的包路径下 扫描所有的 FeignClients 类，并构造 FeignClientFactoryBean 对象来解析 FeignClient 接口。</li><li>解析 FeignClient 注解：<strong>FeignClientFactoryBean</strong> 有两个重要的功能，一个是解析 FeignClient 接口中的请求路径和降级函数的配置信息；另一个是触发动态代理的构造过程。其中，动态代理构造是由更下一层的 ReflectiveFeign 完成的。</li><li>构建动态代理对象：<strong>ReflectiveFeign</strong> 包含了 OpenFeign 动态代理的核心逻辑，它主 要负责创建出 FeignClient 接口的动态代理对象。ReflectiveFeign 在这个过程中有两个 重要任务，一个是解析 FeignClient 接口上各个方法级别的注解，将其中的远程接口 URL、接口类型（GET、POST 等）、各个请求参数等封装成元数据，并为每一个方法 生成一个对应的 MethodHandler 类作为方法级别的代理；另一个重要任务是将这些 MethodHandler 方法代理做进一步封装，通过 Java 标准的动态代理协议，构建一个实 现了 InvocationHandler 接口的动态代理对象，并将这个动态代理对象绑定到FeignClient 接口上。这样一来，所有发生在 FeignClient 接口上的调用，最终都会由它 背后的动态代理对象来承接。</li></ol><blockquote><p>MethodHandler 的构建过程涉及到了复杂的元数据解析，OpenFeign 组件将 FeignClient 接口上的各种注解封装成元数据，并利用这些元数据把一个方法调用“翻译”成一个远程调用的 Request 请求。</p><p>“元数据的解析”是如何完成的呢？它依赖于 OpenFeign 组件中的 Contract 协议解析功能。Contract 是 OpenFeign 组件中定义的顶层抽象接口，它有一系 列的具体实现，其中和我们实战项目有关的是 SpringMvcContract 这个类，从这个类的名 字中我们就能看出来，它是专门用来解析 Spring MVC 标签的。</p><p>SpringMvcContract 的继承结构是 SpringMvcContract-&gt;BaseContract-&gt;Contract。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析FeignClient接口方法级别上的RequestMapping注解</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAnnotationOnMethod</span><span class="params">(MethodMetadata data,</span></span></span><br><span class="line"><span class="function"><span class="params">		Annotation methodAnnotation, Method method)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略部分代码...</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 如果方法上没有使用RequestMapping注解，则不进行解析</span></span><br><span class="line">	<span class="comment">// 其实GetMapping、PostMapping等注解都属于RequestMapping注解</span></span><br><span class="line">	<span class="keyword">if</span> (!RequestMapping.class.isInstance(methodAnnotation) &amp;&amp; !methodAnnotation</span><br><span class="line">			.annotationType().isAnnotationPresent(RequestMapping.class)) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 获取RequestMapping注解实例</span></span><br><span class="line">	RequestMapping methodMapping = findMergedAnnotation(method, RequestMapping.class);</span><br><span class="line">	<span class="comment">// HTTP Method</span></span><br><span class="line">	RequestMethod[] methods = methodMapping.method();</span><br><span class="line">       <span class="comment">// 如果没有定义methods属性则默认当前方法是个GET方法</span></span><br><span class="line">	<span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">		methods = <span class="keyword">new</span> RequestMethod[] &#123; RequestMethod.GET &#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	checkOne(method, methods, <span class="string">&quot;method&quot;</span>);</span><br><span class="line">	data.template().method(Request.HttpMethod.valueOf(methods[<span class="number">0</span>].name()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//  解析Path属性，即方法上写明的请求路径</span></span><br><span class="line">	checkAtMostOne(method, methodMapping.value(), <span class="string">&quot;value&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (methodMapping.value().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		String pathValue = emptyToNull(methodMapping.value()[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">if</span> (pathValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">			pathValue = resolve(pathValue);</span><br><span class="line">			<span class="comment">// Append path from @RequestMapping if value is present on method</span></span><br><span class="line">			<span class="keyword">if</span> (!pathValue.startsWith(<span class="string">&quot;/&quot;</span>) &amp;&amp; !data.template().path().endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">				pathValue = <span class="string">&quot;/&quot;</span> + pathValue;</span><br><span class="line">			&#125;</span><br><span class="line">			data.template().uri(pathValue, <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// produces</span></span><br><span class="line">	parseProduces(data, method, methodMapping);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// consumes</span></span><br><span class="line">	parseConsumes(data, method, methodMapping);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// headers</span></span><br><span class="line">	parseHeaders(data, method, methodMapping);</span><br><span class="line"></span><br><span class="line">	data.indexToExpander(<span class="keyword">new</span> LinkedHashMap&lt;&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过上面的方法，我们可以看到，OpenFeign 对 RequestMappings 注解的各个属性都做 了解析。</p><p><strong>Debug</strong></p><p>在 OpenFeign 组件的 FeignClientsRegistrar 中打上一个断点，这是 OpenFeign 初始化的起点</p><p><strong>日志信息打印</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">    level:</span><br><span class="line">        com.geekbang.coupon.customer.feign.TemplateService: debug</span><br><span class="line">        com.geekbang.coupon.customer.feign.CalculationService: debug</span><br></pre></td></tr></table></figure><p>还需要在应用的上下文中使用代码的方式声明 Feign 组件的日志级别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在 Configuration 配置类中</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">Logger.<span class="function">Level <span class="title">feignLogger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>OpenFeign 超时判定</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">    client:</span><br><span class="line">        config:</span><br><span class="line">        <span class="comment"># 全局超时配置</span></span><br><span class="line">        default:</span><br><span class="line">            <span class="comment"># 网络连接阶段1秒超时</span></span><br><span class="line">            connectTimeout: 1000</span><br><span class="line">            <span class="comment"># 服务请求响应阶段5秒超时</span></span><br><span class="line">            readTimeout: 5000</span><br><span class="line">            <span class="comment"># 针对某个特定服务的超时配置</span></span><br><span class="line">        coupon-template-serv:</span><br><span class="line">            connectTimeout: 1000</span><br><span class="line">            readTimeout: 2000</span><br></pre></td></tr></table></figure><p><strong>OpenFeign 降级</strong></p><p>降级逻辑是在远程服务调用发生超时或者异常（比如 400、500 Error Code）的时候，自 动执行的一段业务逻辑。可以根据具体的业务需要编写降级逻辑，比如执行一段兜底逻辑将服务请求从失败状态中恢复，或者发送一个失败通知到相关团队提醒它们来线上排查 问题。</p><p><strong>OpenFeign 实现 Client 端的服务降级</strong></p><p>OpenFeign 对服务降级的支持是借助 Hystrix 组件实现的</p><p>OpenFeign 支持两种不同的方式来指定降级逻辑，一种是定义 fallback 类，另一种是定义 fallback 工厂</p><p>通过 fallback 类实现降级是最为简单的一种途径</p><p>如果你想要在降级方法中获取到异常的具体原因，那么你就要借助 fallback 工厂的方式来 指定降级逻辑了</p><p><strong>自定义的 fallback 工厂需要实现 FallbackFactory 接口</strong></p><p><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209210036491.png" alt="image-20220921003602982"></p></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud%E7%B3%BB%E5%88%97/">SpringCloud系列</a></div><div class="post_share"><div class="social-share" data-image="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202213367.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/kele.png" target="_blank"><img class="post-qr-code-img" src="/img/kele.png" alt="觉得还不错，请他喝一瓶可乐"></a><div class="post-qr-code-desc">觉得还不错，请他喝一瓶可乐</div></li><li class="reward-item"><a href="/img/ali.jpg" target="_blank"><img class="post-qr-code-img" src="/img/ali.jpg" alt="雪碧也是可以的"></a><div class="post-qr-code-desc">雪碧也是可以的</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/20220906/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8CMVCC/"><img class="next-cover" src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202205242214058.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">事务隔离级别和MVCC</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/20220710/如何搭建自己的网盘/" title="如何搭建自己的网盘"><img class="cover" src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202207101923657.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-10</div><div class="title">如何搭建自己的网盘</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/tx2.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-info__name">章志成</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">79</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gitee.com/gump12138"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cooper12138" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:994739211@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">延迟满足</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nacos"><span class="toc-number">1.</span> <span class="toc-text">Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">1.1.1.</span> <span class="toc-text">核心功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">快速开始</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenFeign"><span class="toc-number">2.</span> <span class="toc-text">OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign-%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86"><span class="toc-number">2.1.</span> <span class="toc-text">OpenFeign 的动态代理</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/20220920/SpringCloud-Alibaba-Nacos/" title="SpringCloud-Alibaba-第一章"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202209202213367.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="SpringCloud-Alibaba-第一章"></a><div class="content"><a class="title" href="/20220920/SpringCloud-Alibaba-Nacos/" title="SpringCloud-Alibaba-第一章">SpringCloud-Alibaba-第一章</a><time datetime="2022-09-20T14:11:58.000Z" title="发表于 2022-09-20 22:11:58">2022-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220906/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8CMVCC/" title="事务隔离级别和MVCC"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202205242214058.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="事务隔离级别和MVCC"></a><div class="content"><a class="title" href="/20220906/%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8CMVCC/" title="事务隔离级别和MVCC">事务隔离级别和MVCC</a><time datetime="2022-09-05T16:18:52.000Z" title="发表于 2022-09-06 00:18:52">2022-09-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220828/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/" title="设计模式总结"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208282314841.jpeg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="设计模式总结"></a><div class="content"><a class="title" href="/20220828/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/" title="设计模式总结">设计模式总结</a><time datetime="2022-08-28T15:11:14.000Z" title="发表于 2022-08-28 23:11:14">2022-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/" title="spring-cache+redis自定义cache"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202208132131962.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="spring-cache+redis自定义cache"></a><div class="content"><a class="title" href="/20220813/spring-cache-redis%E8%87%AA%E5%AE%9A%E4%B9%89cache/" title="spring-cache+redis自定义cache">spring-cache+redis自定义cache</a><time datetime="2022-08-13T13:29:30.000Z" title="发表于 2022-08-13 21:29:30">2022-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/20220710/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%9B%98/" title="如何搭建自己的网盘"><img src="https://bolg2022.oss-cn-hangzhou.aliyuncs.com/202207101923657.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="如何搭建自己的网盘"></a><div class="content"><a class="title" href="/20220710/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BD%91%E7%9B%98/" title="如何搭建自己的网盘">如何搭建自己的网盘</a><time datetime="2022-07-10T11:22:08.000Z" title="发表于 2022-07-10 19:22:08">2022-07-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 章志成</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://hankz.cc/">一个cv大师</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>function loadValine(){function e(){new Valine(Object.assign({el:"#vcomment",appId:"rX8EGp1QDIbaOBer0HPXb4wr-gzGzoHsz",appKey:"zYi2FKT3jfoRihSzwUQkzwd3",placeholder:"Please leave your footprints",avatar:"monsterid",meta:"nick,mail,link".split(","),pageSize:"10",lang:"zh-CN",recordIP:!1,serverURLs:"",emojiCDN:"",emojiMaps:"",enableQQ:!1,path:window.location.pathname,requiredFields:["nick,mail"],visitor:!1},null))}"function"==typeof Valine?e():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(e)}function loadOtherComment(){loadValine()}setTimeout(loadValine,0)</script></div><div class="aplayer no-destroy" data-id="84943176" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-autoplay="false" data-theme="#2980b9" data-loop="all" data-order="random" data-preload="auto" data-volume="0.4" data-mutex="true" data-listfolded="true" data-listmaxheight="340px" data-storagename="metingjs" muted></div><div class="aplayer no-destroy" data-id="https://music.163.com/playlist?id=84943176&userid=77272308" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-autoplay="true" data-theme="#2980b9" data-loop="all" data-order="random" data-preload="auto" data-volume="0.4" data-mutex="true" data-listfolded="true" data-listmaxheight="340px" data-storagename="metingjs" muted></div><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async mobile="true"></script><script>!function(t,a,n){a.ChatraID="K3d9XytKCJ4u5JfPd";var c=t.createElement("script");a[n]=a[n]||function(){(a[n].q=a[n].q||[]).push(arguments)},c.async=!0,c.src="https://call.chatra.io/chatra.js",t.head&&t.head.appendChild(c)}(document,window,"Chatra");var chatBtnFn=()=>{document.getElementById("chat_btn").addEventListener("click",function(){Chatra("openChat")})};function chatBtnHide(){Chatra("hide")}function chatBtnShow(){Chatra("show")}chatBtnFn()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script");var o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()}),document.addEventListener("pjax:send",function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>